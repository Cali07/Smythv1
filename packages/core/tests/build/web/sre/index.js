import"source-map-support/register.js";import"dotenv/config";import e from"winston";import t from"winston-transport";import s from"p-limit";import*as n from"file-type";import{fileTypeFromBuffer as o}from"file-type";import"isbinaryfile";import r from"axios";import a from"dotenv";import i,{EventEmitter as l}from"events";import c from"joi";import u from"dayjs";import{xxh3 as m}from"@node-rs/xxhash";import p from"mime";import{Readable as d}from"stream";import{jsonrepair as h}from"jsonrepair";import g from"crypto";import{OpenAIEmbeddings as f}from"@langchain/openai";import{RecursiveCharacterTextSplitter as y}from"@langchain/textsplitters";import b from"fs";import w from"path";import{encodeChat as A,encode as k}from"gpt-tokenizer";import x from"js-yaml";import _ from"@apidevtools/swagger-parser";import I from"@apidevtools/json-schema-ref-parser";import v from"os";import"process";import{S3Client as C,GetObjectCommand as L,PutObjectCommand as P,DeleteObjectCommand as O,HeadObjectCommand as T}from"@aws-sdk/client-s3";import R from"image-size";import S from"openai";import{GoogleGenerativeAI as E}from"@google/generative-ai";import{GoogleAIFileManager as M,FileState as D}from"@google/generative-ai/server";import q from"@anthropic-ai/sdk";import $ from"ioredis";import{Pinecone as N}from"@pinecone-database/pinecone";var j=Object.defineProperty,G=(e,t,s)=>((e,t,s)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class B{constructor(e){if(G(this,"headers"),G(this,"body"),G(this,"query"),G(this,"params"),G(this,"method","GET"),G(this,"path",""),G(this,"sessionID",""),G(this,"res",null),G(this,"req",null),G(this,"files",[]),G(this,"_agent_authinfo"),e){if(this.headers=JSON.parse(JSON.stringify(e.headers||{})),this.body=JSON.parse(JSON.stringify(e.body||e.data||{})),this.query=JSON.parse(JSON.stringify(e.query||{})),this.params=JSON.parse(JSON.stringify(e.params||{})),e.url){const t=new URL(e.url||"");this.path=t.pathname}e.path&&(this.path=e.path),this.method=e.method,this.sessionID=e.sessionID,this.files=e.files||[],this._agent_authinfo=e._agent_authinfo,this.req=e instanceof B?e?.req:e,this.res=e?.res||null}}header(e){return this.headers[e.toLowerCase()]}}var V,U=((V=U||{}).Storage="Storage",V.VectorDB="VectorDB",V.Cache="Cache",V.LLM="LLM",V.Vault="Vault",V.Account="Account",V.AgentData="AgentData",V.CLI="CLI",V.NKV="NKV",V);function F(){return(Date.now()+Math.random()).toString(36).replace(".","").toUpperCase()}async function K(e,t=10){const n=s(t),o=e.map((e=>n(e)));return(await Promise.allSettled(o)).flatMap((e=>"fulfilled"===e.status?[e.value]:[]))}function J(e){return new Promise((t=>setTimeout(t,e)))}function z(e){return e&&"string"==typeof e}function W(e){return e.replace(/\s|\\n|\\s/g,"")}function H(e){return/^data:([\w+\-\.]+\/[\w+\-\.]+);base64,(.*)$/.test(e)}function Q(e){if(!z(e))return!1;const t=W(e);if(t.length<128)return!1;try{return Buffer.from(t,"base64").toString("base64").replace(/=+$/,"")===t.replace(/=+$/,"")}catch{return!1}}async function Y(e){try{if(H(e))return function(e){const t=/^data:([\w+\-\.]+\/[\w+\-\.]+);base64,(.*)$/,s=e.match(t);if(!s)throw new Error("Invalid data URL!");const[,n,o]=s;if(!Q(o))throw new Error("Invalid base64 data!");return{mimetype:n,data:W(o)}}(e);if(!Q(e))throw new Error("Invalid base64 data!");return await async function(e){const t=W(e);return{mimetype:await X(t),data:t}}(e)}catch(e){throw new Error(`Error parsing base64 data: ${e.message}`)}}async function X(e){try{const t=W(e),s=Buffer.from(t,"base64");return(await o(s))?.mime||""}catch(e){throw new Error(`Error identifying MIME type from base64 data: ${e?.message}`)}}async function Z(e){const t=[];for await(const s of e)t.push("string"==typeof s?Buffer.from(s):s);return Buffer.concat(t)}const ee=e=>{const t=function(e){let t;switch(!0){case e instanceof ArrayBuffer:t=Buffer.from(new Uint8Array(e));break;case ArrayBuffer.isView(e)&&!(e instanceof DataView):t=Buffer.from(new Uint8Array(e.buffer));break;case e instanceof DataView:t=Buffer.from(new Uint8Array(e.buffer,e.byteOffset,e.byteLength));break;case Buffer.isBuffer(e):t=e;break;case"string"==typeof e:t=Buffer.from(e,"utf-8");break;default:return null}return t}(e);return t?t.byteLength:0},te=e=>"object"==typeof e&&null!==e&&!Array.isArray(e)&&"[object Object]"===Object.prototype.toString.call(e)&&e.constructor===Object;function se(e){return"string"==typeof e&&/^([a-zA-Z0-9]+:\/\/)([^\s.]+\.[^\s]{2,})(:[0-9]{1,5})?(\/[^\s]*)?(\?[^\s]*)?$/i.test(e)}function ne(e,t){t||(t=process.argv);const s=t,n={};return(Array.isArray(e)?e:[e]).forEach((e=>{const t=s.indexOf(`--${e}`);if(-1!==t){const o=[];for(let e=t+1;e<s.length&&!s[e].startsWith("--");e++)o.push(s[e]);if(1===o.length&&o[0].includes("=")){const t={},[s,...r]=o[0].split("="),a=r.join("=").replace(/^"|"$/g,"");t[s]=a,n[e]=t}else if(1===o.length)n[e]=o[0];else if(o.length>1){const t={};o.forEach((e=>{const[s,...n]=e.split("="),o=n.join("=").replace(/^"|"$/g,"");t[s]=o})),n[e]=t}}})),n}async function oe(e){try{const{data:t}=await r.get(e,{responseType:"arraybuffer",headers:{Range:"bytes=0-4096"}}),s=await o(t);return s?s.mime:""}catch(e){throw new Error(`Error fetching the MIME type: ${e.message}`)}}function re(e){if(""===e)return!0;const t=e.split(/(\{\{[^}]+\}\})/).filter(Boolean);for(const e of t)if(e.startsWith("{{")&&e.endsWith("}}")){if(""===e.slice(2,-2).trim())return!1}else if(!/^[a-zA-Z0-9\-_.]+$/.test(e))return!1;return!0}const ae=e=>(t,s)=>{const n=Number(t),o=s.schema._flags.label||s.state.path[s.state.path.length-1];if(isNaN(n))throw new Error(`The value for '${o}' must be a number`);if(void 0!==e.min&&void 0!==e.max){if(n<e.min||n>e.max)throw new Error(`The value for '${o}' must be from ${e.min} to ${e.max}`)}else if(void 0!==e.min){if(n<e.min)throw new Error(`The value for '${o}' must be greater or equal to ${e.min}`)}else if(void 0!==e.max&&n>e.max)throw new Error(`The value for '${o}' must be less or equal to ${e.max}`);return t};a.config();const ie={env:{LOG_LEVEL:process.env.LOG_LEVEL||"none",LOG_FILTER:process.env.LOG_FILTER||"",OPENAI_API_KEY:process.env.OPENAI_API_KEY,ANTHROPIC_API_KEY:process.env.ANTHROPIC_API_KEY,DATA_PATH:process.env.DATA_PATH,NODE_ENV:process.env?.NODE_ENV,AGENT_DOMAIN:process.env?.AGENT_DOMAIN,AGENT_DOMAIN_PORT:process.env?.AGENT_DOMAIN_PORT,CODE_SANDBOX_URL:process.env?.CODE_SANDBOX_URL,TOGETHER_AI_API_URL:process.env?.TOGETHER_AI_API_URL,REDIS_SENTINEL_HOSTS:process.env?.REDIS_SENTINEL_HOSTS||"",REDIS_MASTER_NAME:process.env?.REDIS_MASTER_NAME,REDIS_PASSWORD:process.env?.REDIS_PASSWORD,AWS_ACCESS_KEY_ID:process.env.AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY:process.env.AWS_SECRET_ACCESS_KEY,AWS_S3_REGION:process.env.AWS_S3_REGION,AWS_S3_BUCKET_NAME:process.env.AWS_S3_BUCKET_NAME,PINECONE_API_KEY:process.env.PINECONE_API_KEY,PINECONE_INDEX_NAME:process.env.PINECONE_INDEX_NAME},agent:{ENDPOINT_PREFIX:"/api"}};var le=Object.defineProperty,ce=(e,t,s)=>((e,t,s)=>t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);e.addColors({error:"red",warn:"yellow",info:"green",debug:"blue"});let ue=ne("debug")?.debug||ie.env.LOG_LEVEL||"info";["none","error","warn","info","debug"].includes(ue)||(ue="none");const me=(ie.env.LOG_FILTER||"").split(","),pe=e.format((e=>!(ie.env.LOG_FILTER&&!me.some((t=>e.module?.includes(t))))&&e))();class de extends t{constructor(e){super(e),ce(this,"logs"),this.logs=e.logs}log(e,t){setImmediate((()=>{this.emit("logged",e)})),this.logs.push(`${e.level}: ${e.message}`),t()}}class he{constructor(e,t,s){this._logger=e,this.data=t,this.labels=s,ce(this,"startTime",Date.now())}get output(){return Array.isArray(this.data)?this.data.join("\n"):void 0}get elapsedTime(){return Date.now()-this.startTime}log(...e){this._logger.log("info",ge(...e),this.labels)}warn(...e){this._logger.log("warn",ge(...e),this.labels)}debug(...e){this._logger.log("debug",ge(...e),this.labels)}info(...e){this._logger.log("info",ge(...e),this.labels)}verbose(...e){this._logger.log("verbose",ge(...e),this.labels)}error(...e){const t=(new Error).stack;this._logger.log("error",ge(...e),{...this.labels,stack:t})}close(){this._logger.clear(),this._logger.close()}}function ge(...e){return e.map((e=>"object"!=typeof e||null===e||e instanceof Error?String(e):JSON.stringify(e,null,2))).join(" ")}function fe(t,s){const n=function(t){const s=e.createLogger({format:e.format.combine(e.format((e=>"none"!=ie.env.LOG_LEVEL&&e))(),e.format.timestamp(),e.format.errors({stack:!0}),e.format.splat(),e.format.json()),transports:[new e.transports.Console({level:"error",format:e.format.combine(e.format.printf((e=>{let t=e.message;return`${e.level}:${e.module||""} ${t} ${e.stack||""}`}))),stderrLevels:["error"]}),new e.transports.Console({level:ue,format:e.format.combine(pe,e.format.printf((t=>{const s=t.module?e.format.colorize().colorize(t.level,` [${t.module}]`):"";return`${e.format.colorize().colorize(t.level,`${t.level}${s}`)} - ${t.message}`})))})]});return Array.isArray(t)&&s.add(new de({level:"debug",logs:t})),s}(s);return n.defaultMeta=t,new he(n,s,t)}function ye(e,t=!1){return fe({module:e},t?[]:void 0)}e.format.printf((t=>`${t.timestamp} ${e.format.colorize().colorize(t.level,`${t.level}: ${t.message}`)}`));const be=ye("DummyConnector"),we=new Proxy({},{get:function(e,t,s){return"function"==typeof e[t]?e[t]:function(...e){be.warn(`[!!] Unimplemented Connector tried to call : ${t.toString()} with arguments:`,e)}}});var Ae=Object.defineProperty,ke=(e,t,s)=>((e,t,s)=>t in e?Ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const xe=ye("Connector");class _e{constructor(){ke(this,"started",!1),ke(this,"_readyPromise")}async start(){xe.info(`Starting ${this.name} connector ...`),this.started=!0}async stop(){xe.info(`Stopping ${this.name} connector ...`)}ready(){return this._readyPromise||(this._readyPromise=new Promise((e=>{let t=1e4;if(this.started)e(!0);else{const s=setInterval((()=>{this.started&&(clearInterval(s),e(!0)),t-=100,t<=0&&(clearInterval(s),e(!1))}),100)}}))),this._readyPromise}}const Ie=new l,ve=ye("ConnectorService"),Ce={},Le={};let Pe={},Oe=!1;Ie.on("SRE:Booted",(e=>{Pe=e,Oe=!0}));class Te{static get ready(){return Oe}static get service(){return Pe}static register(e,t,s){"function"==typeof s&&function(e,t){if("function"!=typeof e||"function"!=typeof t)return!1;let s=Object.getPrototypeOf(e.prototype),n=10;for(;s&&n>=0;){if(s===t.prototype)return!0;s=Object.getPrototypeOf(s),n++}return!1}(s,_e)?(Ce[e]||(Ce[e]={}),Ce[e][t]=s):ve.error(`Invalid Connector ${e}:${t}`)}static init(e,t,s={},n=!1){if(Le[e]?.[t])throw new Error(`Connector ${e}:${t} already initialized`);const o=Ce[e];if(!o)return;const r=o[t];if(r){const o=new r(s);o.start(),Le[e]||(Le[e]={}),Le[e][t]=o,!Le[e].default&&n&&(Le[e].default=o)}}static async _stop(){for(let e in Le){let t=Object.values(Le[e]);t=t.filter(((e,t,s)=>s.indexOf(e)===t));for(let e of t)e.stop()}}static getInstance(e,t="default"){return Le[e]?.[t]||(Le[e]&&Object.keys(Le[e]).length>0?Le[e][Object.keys(Le[e])[0]]:(ve.warn(`Connector ${e} not initialized returning DummyConnector`),we))}static getStorageConnector(e){return Te.getInstance(U.Storage,e)}static getCacheConnector(e){return Te.getInstance(U.Cache,e)}static getVectorDBConnector(e){return Te.getInstance(U.VectorDB,e)}static getNKVConnector(e){return Te.getInstance(U.NKV,e)}static getLLMConnector(e){return Te.getInstance(U.LLM,e)}static getVaultConnector(e){return Te.getInstance(U.Vault,e)}static getAccountConnector(e){return Te.getInstance(U.Account,e)}static getAgentDataConnector(e){return Te.getInstance(U.AgentData,e)}static getCLIConnector(e){return Te.getInstance(U.CLI,e)}static hasInstance(e,t="default"){const s=Le[e]?.[t];return s&&s!==we}}class Re{init(){}constructor(){this.register()}}var Se=Object.defineProperty,Ee=(e,t,s)=>((e,t,s)=>t in e?Se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);ye("EmbodimentSettings");class Me{constructor(e){Ee(this,"_embodiments"),Ee(this,"_ready",!1),this.init(e)}async init(e){this._embodiments=e,this._ready=!0}ready(e=1e4){return new Promise(((t,s)=>{const n=setInterval((()=>{this._ready&&(clearInterval(n),t(!0)),e-=100}),100);setTimeout((()=>{clearInterval(n),s(!1)}),e)}))}get(e,t){if(!this._embodiments)return;const s=this._embodiments.find((t=>t.type?.toLowerCase()===e.toLowerCase()));return t?s?.properties?.[t]:s?.properties}}var De=Object.defineProperty,qe=(e,t,s)=>((e,t,s)=>t in e?De(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);ye("AgentSettings");class $e{constructor(e){qe(this,"_settings"),qe(this,"embodiments"),qe(this,"_ready",!1),e&&this.init(e)}async init(e){const t=Te.getAgentDataConnector();this._settings=await t.getAgentSettings(e).catch((e=>{}))||{},this.embodiments=new Me(this._settings.embodiments),this._ready=!0}ready(e=1e4){return new Promise(((t,s)=>{const n=setInterval((()=>{this._ready&&(clearInterval(n),t(!0)),e-=100}),100);setTimeout((()=>{clearInterval(n),s(!1)}),e)}))}get(e){return this._settings?.find((t=>t.key===e))?.value}set(e,t){this._settings[e]=t}has(e){return this._settings[e]}}var Ne=(e=>(e.None="none",e.Owner="owner",e.Read="read",e.Write="write",e))(Ne||{}),je=(e=>(e.Agent="agent",e.User="user",e.Team="team",e.Public="public",e))(je||{});const Ge={user:"u",agent:"a",team:"t",public:"p"},Be={none:"n",owner:"o",read:"r",write:"w"},Ve=Object.fromEntries(Object.entries(Ge).map((([e,t])=>[t,e]))),Ue=Object.fromEntries(Object.entries(Be).map((([e,t])=>[t,e])));var Fe=(e=>(e.Granted="granted",e.Denied="denied",e))(Fe||{});class Ke extends Error{constructor(e){super(e),this.name="ACLAccessDeniedError"}}var Je=Object.defineProperty,ze=(e,t,s)=>((e,t,s)=>t in e?Je(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class We{constructor(e){if(ze(this,"id"),ze(this,"resourceId"),ze(this,"level",[]),ze(this,"candidate"),e||(this.id="aclR:"+F()),["role","id"].every((t=>t in e)))this.id="aclR:"+F(),this.candidate=e;else{const t=e;this.id=t.id,this.level=t.level,this.candidate=t.candidate}this.resourceId=void 0}static clone(e){return new We(e)}setLevel(e){return this.level=Array.isArray(e)?e:[e],this}addLevel(e){return this.level=[...this.level,...Array.isArray(e)?e:[e]],this}resource(e){return this.resourceId=e,this}setCandidate(e){return this.candidate=e,this}}var He=Object.defineProperty,Qe=(e,t,s)=>((e,t,s)=>t in e?He(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class Ye{constructor(e){Qe(this,"role"),Qe(this,"id"),this.role=e?e.role:je.Public,this.id=e?e.id:""}get request(){return new We(this)}get readRequest(){return new We(this).setLevel(Ne.Read)}get writeRequest(){return new We(this).setLevel(Ne.Write)}get ownerRequest(){return new We(this).setLevel(Ne.Owner)}static clone(e){return new Ye(e)}team(e){return this.role=je.Team,this.id=e,this}static team(e){return new Ye({role:je.Team,id:e})}agent(e){return this.role=je.Agent,this.id=e,this}static agent(e){return new Ye({role:je.Agent,id:e})}user(e){return this.role=je.User,this.id=e,this}static user(e){return new Ye({role:je.User,id:e})}public(){return this.role=je.Public,this.id=je.Public,this}static public(){return new Ye({role:je.Public,id:""})}}var Xe=Object.defineProperty,Ze=(e,t,s)=>((e,t,s)=>t in e?Xe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const et={none:e=>e,xxh3:e=>m.xxh64(e.toString()).toString(16)};class tt{constructor(e){Ze(this,"hashAlgorithm"),Ze(this,"entries"),Ze(this,"migrated"),"string"==typeof e?this.deserializeACL(e):(this.hashAlgorithm=e?.hashAlgorithm,this.entries=e?.entries?JSON.parse(JSON.stringify(e?.entries)):{},this.migrated=e?.migrated),this.hashAlgorithm||(this.hashAlgorithm="xxh3"),this.entries||(this.entries={})}get ACL(){return{hashAlgorithm:this.hashAlgorithm,entries:JSON.parse(JSON.stringify(this.entries)),migrated:this.migrated}}get serializedACL(){return this.serializeACL(this)}static from(e){return new tt(e)}checkExactAccess(e){if(!this?.entries)return!1;const t=this?.entries[e.candidate.role];if(!t)return!1;let s=e.candidate.id;if(!et[this.hashAlgorithm])throw new Error(`Hash algorithm ${this.hashAlgorithm} not supported`);s=et[this.hashAlgorithm](s);const n=t[s];return!!n&&(Array.isArray(e.level)?e.level:[e.level]).every((e=>n.includes(e)))}addPublicAccess(e){if(this?.entries[je.Public]||(this.entries[je.Public]={}),!et[this.hashAlgorithm])throw new Error(`Hash algorithm ${this.hashAlgorithm} not supported`);const t=je.Public,s=et[this.hashAlgorithm](t);this?.entries[je.Public][s]||(this.entries[je.Public][s]=[]);const n=this.entries[je.Public][s];return this.entries[je.Public][s]=[...n,...e],this}removePublicAccess(e){if(!this?.entries[je.Public])return this;const t=je.Public,s=et[this.hashAlgorithm](t),n=this[je.Public][s];return this[je.Public][s]=n.filter((t=>!e.includes(t))),this}addAccess(e,t,s){if(e===je.Public)throw new Error("Adding public access using addAccess method is not allowed. Use addPublicAccess method instead.");const n=Array.isArray(s)?s:[s];if(this?.entries[e]||(this.entries[e]={}),!et[this.hashAlgorithm])throw new Error(`Hash algorithm ${this.hashAlgorithm} not supported`);const o=et[this.hashAlgorithm](t);this?.entries[e][o]||(this.entries[e][o]=[]);const r=this.entries[e][o];return this.entries[e][o]=[...r,...n],this}static addAccess(e,t,s){return tt.from().addAccess(e,t,s)}removeAccess(e,t,s){const n=Array.isArray(s)?s:[s];if(!this[e])return this;if(!this[e][t])return this;const o=this[e][t];return this[e][t]=o.filter((e=>!n.includes(e))),this}serializeACL(e){let t="";if(e.hashAlgorithm&&(t+=`h:${e.hashAlgorithm}|`),e.entries)for(const[s,n]of Object.entries(e.entries)){const e=Ge[s],o=[];for(const[e,t]of Object.entries(n||{}))if(t){const s=t.map((e=>Be[e])).join("");o.push(`${e}/${s}`)}o.length>0&&(t+=`${e}:${o.join(",")}|`)}return t.endsWith("|")&&(t=t.slice(0,-1)),t}deserializeACL(e){const t=e.split("|");this.hashAlgorithm="",this.entries={};for(const e of t)if(e.startsWith("h:"))this.hashAlgorithm=e.substring(2);else{const[t,s]=e.split(":"),n=Ve[t];if(n){const e={},t=s.split(",");for(const s of t){const[t,n]=s.split("/"),o=n.split("").map((e=>Ue[e]));e[t]=o}this.entries[n]=e}}}}var st=Object.defineProperty,nt=(e,t,s)=>((e,t,s)=>t in e?st(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const ot=class e{constructor(){if(nt(this,"storage"),!Te.ready)throw new Error("SRE not available");this.storage=Te.getStorageConnector()}static get Instance(){return this.instance||(this.instance=new e),this.instance}URIParser(e){const t=e.split("://");if(2!==t.length||"smythfs"!==t[0].toLowerCase())return;const s=new URL(`http://${t[1]}`),n=s.hostname.split(".").pop();if("team"!==n)throw new Error("Invalid Resource URI");const o=s.hostname.replace(`.${n}`,"");return{hash:s.hash,team:o,path:s.pathname}}getStoragePath(e){const t=this.URIParser(e);if(!t)throw new Error("Invalid Resource URI");return`teams/${t.team}${t.path}`}async read(e,t){const s=this.URIParser(e);if(!s)throw new Error("Invalid Resource URI");const n=`teams/${s.team}${s.path}`,o=t instanceof Ye?t:new Ye(t),r=await this.storage.user(o).read(n);return this.toBuffer(r)}async toBuffer(e){if(Buffer.isBuffer(e))return e;if("string"==typeof e)return Buffer.from(e,"utf-8");if(e instanceof Uint8Array)return Buffer.from(e);if(e instanceof d)return new Promise(((t,s)=>{const n=[];e.on("data",(e=>{n.push(Buffer.isBuffer(e)?e:Buffer.from(e))})),e.on("end",(()=>{t(Buffer.concat(n))})),e.on("error",(e=>{s(e)}))}));throw new Error("Unsupported data type")}async write(e,t,s,n){const o=this.URIParser(e);if(!o)throw new Error("Invalid Resource URI");if(!await Te.getAccountConnector().isTeamMember(o.team,s))throw new Error("Access Denied");const r=`teams/${o.team}${o.path}`,a=s instanceof Ye?s:new Ye(s),i=(new tt).addAccess(je.Team,o.team,Ne.Read).ACL;if(n||(n={}),!n?.ContentType&&(n.ContentType=await this.getMimeType(t),!n.ContentType)){const t=e.split(".").pop();t&&(n.ContentType=p.getType(t)||"application/octet-stream")}await this.storage.user(a).write(r,t,i,n)}async getMimeType(e){if(e instanceof Blob)return e.type;if((e=>{try{return Buffer.isBuffer(e)}catch{return!1}})(e))try{return(await n.fileTypeFromBuffer(e)).mime}catch{return""}return"string"==typeof e?"text/plain":void 0}async delete(e,t){const s=this.URIParser(e);if(!s)throw new Error("Invalid Resource URI");const n=`teams/${s.team}${s.path}`,o=t instanceof Ye?t:new Ye(t);await this.storage.user(o).delete(n)}async exists(e,t){const s=this.URIParser(e);if(!s)throw new Error("Invalid Resource URI");const n=`teams/${s.team}${s.path}`,o=t instanceof Ye?t:new Ye(t);return await this.storage.user(o).exists(n)}};nt(ot,"instance");let rt=ot;var at=Object.defineProperty,it=(e,t,s)=>((e,t,s)=>t in e?at(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class lt{constructor(e,t,s){this._name=t,this.mimetype=s,it(this,"size"),it(this,"url"),it(this,"_ready"),it(this,"_readyPromise"),it(this,"_source"),it(this,"_uploading",!1),t||(t=F()),this.load(e,t,s)}async ready(){return!!this._ready||(this._readyPromise||(this._readyPromise=new Promise((e=>{const t=setInterval((()=>{this._ready&&(clearInterval(t),e(!0))}),100)}))),this._readyPromise)}async load(e,t,s){const o=t.split(".").pop();if(this.mimetype=s||p.getType(o)||"application/octet-stream",this.url="","object"==typeof e&&e.url&&e.mimetype&&e.size)return this.mimetype=e.mimetype,this.size=e.size,this.url=e.url,void(this._ready=!0);if(se(e)){const t=await this.getUrlInfo(e);this.mimetype=t.contentType,this.size=t.contentLength;try{const t=await r({method:"get",url:e,responseType:"arraybuffer"});this._source=Buffer.from(t.data,"binary"),this.size=t.data.byteLength;const s=p.getExtension(this.mimetype);this._name.endsWith(`.${s}`)||(this._name+=`.${s}`)}catch{console.error("Error loading binary data from url:",e.url)}return void(this._ready=!0)}const a=await this.getBase64FileInfo(e);if(a){this.mimetype=a.mimetype,this.size=a.size,this._source=a.data;const e=p.getExtension(this.mimetype);return this._name.endsWith(`.${e}`)||(this._name+=`.${e}`),void(this._ready=!0)}if("string"==typeof e)return this._source=Buffer.from(e),this.size=e.length,this.mimetype="text/plain",this._name.endsWith(".txt")||(this._name+=".txt"),void(this._ready=!0);if(Buffer.isBuffer(e)){this._source=e,this.size=ee(e);const t=await n.fileTypeFromBuffer(e);this.mimetype=t.mime;const s=p.getExtension(this.mimetype);this._name.endsWith(`.${s}`)||(this._name+=`.${s}`)}this._ready=!0}async getUrlInfo(e){try{const t=await r.head(e),s=t.headers["content-type"];return{contentType:s,contentLength:t.headers["content-length"]}}catch{return{contentType:"",contentLength:0}}}async getBase64FileInfo(e){if(!/data:[^;]+;base64,[A-Za-z0-9+\/]*(={0,2})?$/gm.test(e))return null;const t=e.split(",")[1],s=Buffer.from(t,"base64"),o=s.byteLength,r=await n.fileTypeFromBuffer(s);return{size:o,data:s,mimetype:r?.mime||""}}static from(e,t,s){return e instanceof lt?e:new lt(e,t,s)}async upload(e){if(await this.ready(),!this._uploading)try{if(this._uploading=!0,!this.url){const t=await Te.getAccountConnector().getCandidateTeam(e);this.url=`smythfs://${t}.team/${e.id}/_temp/${this._name}`,await rt.Instance.write(this.url,this._source,e),this._uploading=!1}}catch(e){console.error("Error uploading binary data:",e),this._uploading=!1}}async getJsonData(e){return await this.upload(e),{mimetype:this.mimetype,size:this.size,url:this.url}}async readData(e){if(await this.ready(),!this.url)throw new Error("Binary data not ready");return await rt.Instance.read(this.url,e)}async getBuffer(){return await this.ready(),this._source}}var ct=Object.defineProperty,ut=(e,t,s)=>((e,t,s)=>t in e?ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class mt{constructor(e){this.dataString=e,ut(this,"_current"),this._current=e}get result(){return this._current}static create(e){return new mt(e)}tryParse(){const e=this._current;if(!z(e))return e;let t=(this.extractJsonFromString(e)||e).trim();if(function(e){return"number"==typeof e||"string"==typeof e&&/^-?\d+(\.\d+)?$/.test(e.trim())}(t)&&!function(e){const t=parseFloat(e);return!isNaN(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER&&t.toString()===e.trim()}(t)||!t.startsWith("{")&&!t.startsWith("["))return t;try{return JSON.parse(t)}catch{try{return JSON.parse(h(t))}catch{return e}}}extractJsonFromString(e){try{const t=/(\{.*\})/s;return e.match(t)?.[1]}catch{return null}}}function pt(e){return mt.create(e)}const dt={any:async function(e){return e},string:async function(e,t,s){return null==e||"null"===e||"undefined"===e?"":Q(e)||H(e)?e:"object"==typeof e||Array.isArray(e)?JSON.stringify(e):String(e)},number:async function(e,t,s){const n=parseFloat(e);if(isNaN(n))throw new Error("Invalid Number value");return n},integer:async function(e,t,s){const n=parseInt(e);if(isNaN(n))throw new Error("Invalid Integer value");return n},boolean:async function(e,t,s){if("boolean"==typeof e)return e;if("string"==typeof e||"number"==typeof e){const t=String(e).toLowerCase();if(["true","1"].includes(t))return!0;if(["false","0"].includes(t))return!1;throw new Error("Invalid Boolean value")}throw new Error("Invalid Boolean value")},array:async function(e,t,s){try{if(Array.isArray(e))return e;if("string"!=typeof e)throw new Error("Invalid Array value");try{return e.trim().startsWith("[")?pt(e).tryParse():e.split(",")}catch{throw new Error("Invalid Array value")}}catch{throw new Error("Invalid Array value")}},object:async function(e,t,s){try{const t=te(e)?e:pt(e).tryParse();if(!te(t))throw new Error("Invalid Object value");return t}catch{throw new Error("Invalid Object value")}},binary:async function(e,t,s){return await lt.from(e,F()+"-"+t).getJsonData(Ye.agent(s.id))},date:async function(e,t,s){const n="Invalid Date value\nThe date string is expected to be in a format commonly used in English-speaking countries.";if("string"!=typeof e&&"number"!=typeof e)throw new Error(n);let o;if("string"==typeof e&&isNaN(Number(e)))o=u(e).locale("en");else{const t="number"==typeof e?e:Number(e);o=u.unix(t/1e3)}if(!o.isValid())throw new Error(n);return o.toISOString()}};async function ht(e,t,s){try{if(!t||0===Object.keys(t)?.length)return e;const n={...e},o={};for(const e of t)e?.name&&(o[e.name]={...e});for(const[t,r]of Object.entries(o)){let o=e?.[t]||"";if(!o)continue;const a=r?.type?.toLowerCase()||"any";if(!dt[a])throw new Error(`Invalid type: ${a} for Input: ${t}`);n[t]=await dt[a](o,t,s)}return n}catch(e){throw e}}var gt=Object.defineProperty,ft=(e,t,s)=>((e,t,s)=>t in e?gt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class yt{constructor(){ft(this,"hasReadOutput",!1),ft(this,"hasPostProcess",!0),ft(this,"alwaysActive",!1),ft(this,"exclusive",!1),ft(this,"configSchema")}init(){}createComponentLogger(e,t){return ye(t||this.constructor.name,e?.agentRuntime?.debug)}async validateConfig(e){if(!this.configSchema)return{};if(e.data._templateVars)for(let t in e.data._templateVars)this.configSchema=this.configSchema.append({[t]:c.any()});const t=await this.configSchema.validate(e.data);return t.error?{id:e.id,name:e.name,_error:`Schema Validation error: ${t?.error?.message} on component ${e.displayName}:${e.title}`,_debug:`Schema Validation error: ${t?.error?.message} on component ${e.displayName}:${e.title}`}:{}}async process(e,t,s){const n=await ht(e,t?.inputs,s);for(const[t,s]of Object.entries(n))e[t]=s}async postProcess(e,t,s){return e?.result&&(delete e?.result?._debug,e?.result?._error||delete e?.result?._error),e}async enable(e,t){}async disable(e,t){}readOutput(e,t,s){return null}hasOutput(e,t,s){return!1}}class bt{static async getTeamKey(e,t){return await Te.getVaultConnector().user(Ye.team(t)).get(e)}static async getUserKey(e,t){const s=Te.getVaultConnector(),n=await Te.getAccountConnector().getCandidateTeam(Ye.user(t));return await s.user(Ye.team(n)).get(e)}static async getAgentKey(e,t){const s=Te.getVaultConnector(),n=await Te.getAccountConnector().getCandidateTeam(Ye.agent(t));return await s.user(Ye.team(n)).get(e)}}var wt=Object.defineProperty,At=(e,t,s)=>((e,t,s)=>t in e?wt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const kt={default:/{{(.*?)}}/g,doubleCurly:/{{(.*?)}}/g,singleCurly:/{(.*?)}/g,prefix:e=>new RegExp(`{{${e}(.*?)}}`,"g"),suffix:e=>new RegExp(`{{(.*?)${e}}}`,"g"),prefSuf:(e,t)=>new RegExp(`{{${e}(.*?)${t}}}`,"g"),fn:e=>new RegExp(`{{${e}\\((.*?)\\)}}`,"g")},xt={vaultTeam:e=>async t=>await bt.getTeamKey(t,e)};class _t{constructor(e){this.templateString=e,At(this,"_current"),At(this,"_promiseQueue",[]),this._current=e}get result(){if(this._promiseQueue.length<=0)return this._current;throw new Error("This template object has async results, you should use .asyncResult with await instead of .result")}get asyncResult(){return new Promise((async(e,t)=>{await Promise.all(this._promiseQueue),e(this._current)}))}static create(e){return new _t(e)}parse(e,t=kt.default){return"string"!=typeof this._current||(this._current=this._current.replace(t,((t,s)=>e[s]||t))),this}parseTeamKeys(e){return this.process(xt.vaultTeam(e),kt.fn("KEY"))}process(e,t=kt.default){if("string"!=typeof this._current)return this;let s,n={};const o=[];for(;null!==(s=t.exec(this._current));){const t=s[1];n[t]=s[0];const r=e(t);r instanceof Promise?(r.then((e=>{if(void 0===e)return s[0];n[t]=e})),o.push(r)):n[t]=r}return o.length>0?(new Promise((async(e,s)=>{await Promise.all(o),this.parse(n,t),e(!0)})),this._promiseQueue.push(Promise.all(o))):this.parse(n,t),this}clean(e=kt.default){return"string"!=typeof this._current||(this._current=this._current.replace(e,"")),this}}function It(e){return e&&e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t")}function vt(e){return _t.create(e)}var Ct=Object.defineProperty,Lt=(e,t,s)=>((e,t,s)=>t in e?Ct(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);function Pt(e){return null==e||"string"==typeof e&&""===e.trim()||Array.isArray(e)&&0===e.length||"object"==typeof e&&null!==e&&0===Object.keys(e).length}function Ot(e=""){return!(!e||"string"!=typeof e)&&(e?.match(/{{(.*?)}}/g)??[]).length>0}function Tt(e=""){return!(!e||"string"!=typeof e)&&(e?.match(/{{KEY\((.*?)\)}}/g)??[]).length>0}function Rt(e="",t){return e.replace(/{{KEY\((.*?)\)}}/g,((e,s)=>"teamid"===s?t:""))}var St=Object.defineProperty,Et=(e,t,s)=>((e,t,s)=>t in e?St(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);var Mt={echo:{llm:"Echo",alias:"Echo"},Echo:{llm:"Echo",tokens:128e3,completionTokens:128e3,enabled:!0,components:["PromptGenerator","LLMAssistant","Classifier","VisionLLM","AgentPlugin","Chatbot"]},"gpt-4o-mini":{llm:"OpenAI",alias:"gpt-4o-mini-2024-07-18",components:["PromptGenerator","LLMAssistant","Classifier","VisionLLM","AgentPlugin","Chatbot"],tags:["new"]},"gpt-4o-mini-2024-07-18":{llm:"OpenAI",tokens:2048,completionTokens:2048,enabled:!0,keyOptions:{tokens:128e3,completionTokens:16383}},"gpt-4o":{llm:"OpenAI",alias:"gpt-4o-2024-05-13",components:["PromptGenerator","LLMAssistant","Classifier","VisionLLM","AgentPlugin","Chatbot"],tags:["new"]},"gpt-4o-2024-05-13":{llm:"OpenAI",tokens:2048,completionTokens:2048,enabled:!0,keyOptions:{tokens:128e3,completionTokens:4096}},"gpt-4-turbo-latest":{llm:"OpenAI",alias:"gpt-4-turbo-2024-04-09",components:["PromptGenerator","LLMAssistant","Classifier"]},"gpt-4-turbo":{llm:"OpenAI",alias:"gpt-4-turbo-2024-04-09",components:["PromptGenerator","LLMAssistant","VisionLLM","GPTPlugin","AgentPlugin","Chatbot"],tags:["legacy"]},"gpt-4-turbo-2024-04-09":{llm:"OpenAI",tokens:1024,completionTokens:1024,enabled:!0,keyOptions:{tokens:128e3,completionTokens:4096}},"gpt-4-latest":{llm:"OpenAI",alias:"gpt-4-0613",enabled:!0,components:["PromptGenerator","LLMAssistant"]},"gpt-4":{llm:"OpenAI",tokens:1024,completionTokens:1024,enabled:!0,keyOptions:{tokens:8192,completionTokens:8192},components:["PromptGenerator","LLMAssistant","Classifier","GPTPlugin","AgentPlugin","Chatbot"],tags:["legacy"]},"gpt-4-0613":{llm:"OpenAI",tokens:1024,completionTokens:1024,enabled:!0,hidden:!0,keyOptions:{tokens:8192,completionTokens:8192}},"gpt-4-vision-preview":{llm:"OpenAI",tokens:1024,completionTokens:1024,enabled:!0,keyOptions:{tokens:128e3,completionTokens:4096},components:["VisionLLM"]},"gpt-4-1106-vision-preview":{llm:"OpenAI",tokens:1024,completionTokens:1024,enabled:!0,keyOptions:{tokens:128e3,completionTokens:4096}},"gpt-3.5-turbo-latest":{llm:"OpenAI",alias:"gpt-3.5-turbo-0125",components:["PromptGenerator","LLMAssistant","Classifier","GPTPlugin","AgentPlugin","Chatbot"]},"gpt-3.5-turbo":{llm:"OpenAI",alias:"gpt-3.5-turbo-0125",components:["PromptGenerator","LLMAssistant","Classifier","GPTPlugin","AgentPlugin","Chatbot"],tags:["legacy"]},"gpt-3.5-turbo-0125":{llm:"OpenAI",tokens:2048,completionTokens:2048,enabled:!0,keyOptions:{tokens:16385,completionTokens:4096}},"gpt-3.5-turbo-1106":{llm:"OpenAI",tokens:2048,completionTokens:2048,enabled:!0,keyOptions:{tokens:16384,completionTokens:4096}},"gpt-3.5-turbo-16k":{llm:"OpenAI",alias:"gpt-3.5-turbo-0125",tags:["legacy"]},"gpt-3.5-turbo-0613":{llm:"OpenAI",alias:"gpt-3.5-turbo-0125",tags:["deprecated"]},"claude-3-opus":{llm:"AnthropicAI",alias:"claude-3-opus-20240229",components:["PromptGenerator","LLMAssistant","Classifier","VisionLLM","AgentPlugin","Chatbot"]},"claude-3.5-sonnet":{llm:"AnthropicAI",alias:"claude-3-5-sonnet-20240620",components:["PromptGenerator","LLMAssistant","Classifier","VisionLLM","AgentPlugin","Chatbot"],tags:["new"]},"claude-3-sonnet":{llm:"AnthropicAI",alias:"claude-3-sonnet-20240229",components:["PromptGenerator","LLMAssistant","Classifier","VisionLLM","AgentPlugin","Chatbot"]},"claude-3-haiku":{llm:"AnthropicAI",alias:"claude-3-haiku-20240307",components:["PromptGenerator","LLMAssistant","Classifier","VisionLLM","AgentPlugin","Chatbot"]},"claude-3-opus-20240229":{llm:"AnthropicAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:2e5,completionTokens:4096,enabled:!0}},"claude-3-5-sonnet-20240620":{llm:"AnthropicAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:2e5,completionTokens:4096,enabled:!0}},"claude-3-sonnet-20240229":{llm:"AnthropicAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:2e5,completionTokens:4096,enabled:!0}},"claude-3-haiku-20240307":{llm:"AnthropicAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:2e5,completionTokens:4096,enabled:!0}},"claude-2.1":{llm:"AnthropicAI",tokens:1024,completionTokens:1024,enabled:!1,keyOptions:{tokens:2e5,completionTokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant","Classifier"],tags:["legacy"]},"claude-instant-1.2":{llm:"AnthropicAI",tokens:1024,completionTokens:1024,enabled:!1,keyOptions:{tokens:1e5,completionTokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant","Classifier"],tags:["legacy"]},"gemini-1.5-pro-latest":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:1048576,completionTokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant","VisionLLM","MultimodalLLM"],tags:["legacy"]},"gemini-1.5-pro-latest-stable":{llm:"GoogleAI",alias:"gemini-1.5-pro",components:["PromptGenerator","LLMAssistant","VisionLLM","MultimodalLLM"],tags:["new"]},"gemini-1.5-pro-stable":{llm:"GoogleAI",alias:"gemini-1.5-pro-001",components:["PromptGenerator","LLMAssistant","VisionLLM","MultimodalLLM"],tags:["new"]},"gemini-1.5-pro":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:1048576,completionTokens:8192,enabled:!0}},"gemini-1.5-pro-001":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:1048576,completionTokens:8192,enabled:!0}},"gemini-1.5-flash-latest":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:1048576,completionTokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant","VisionLLM","MultimodalLLM"],tags:["legacy"]},"gemini-1.5-flash-latest-stable":{llm:"GoogleAI",alias:"gemini-1.5-flash",components:["PromptGenerator","LLMAssistant","VisionLLM","MultimodalLLM"],tags:["legacy"]},"gemini-1.5-flash-stable":{llm:"GoogleAI",alias:"gemini-1.5-flash-001",components:["PromptGenerator","LLMAssistant","VisionLLM","MultimodalLLM"],tags:["new"]},"gemini-1.5-flash":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:1048576,completionTokens:8192,enabled:!0}},"gemini-1.5-flash-001":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:1048576,completionTokens:8192,enabled:!0}},"gemini-1.0-pro-latest":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:30720,completionTokens:2048,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"gemini-1.0-pro-latest-stable":{llm:"GoogleAI",alias:"gemini-1.0-pro",components:["PromptGenerator","LLMAssistant"]},"gemini-1.0-pro-stable":{llm:"GoogleAI",alias:"gemini-1.0-pro-001",components:["PromptGenerator","LLMAssistant"]},"gemini-1.0-pro":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:30720,completionTokens:2048,enabled:!0}},"gemini-1.0-pro-001":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:30720,completionTokens:2048,enabled:!0}},"gemini-pro-vision":{llm:"GoogleAI",tokens:2048,completionTokens:2048,enabled:!1,keyOptions:{tokens:12288,completionTokens:4096,enabled:!0},components:["VisionLLM"]},"groq-llama-3.1-405b-reasoning":{llm:"Groq",alias:"llama-3.1-405b-reasoning",components:["PromptGenerator","LLMAssistant"],tags:["new"]},"llama-3.1-405b-reasoning":{llm:"Groq",tokens:16e3,completionTokens:16e3,enabled:!1,keyOptions:{tokens:131072,completionTokens:131072,enabled:!0}},"groq-llama-3.1-70b-versatile":{llm:"Groq",alias:"llama-3.1-70b-versatile",components:["PromptGenerator","LLMAssistant"],tags:["new"]},"llama-3.1-70b-versatile":{llm:"Groq",tokens:8e3,completionTokens:8e3,enabled:!1,keyOptions:{tokens:131072,completionTokens:131072,enabled:!0}},"groq-llama-3.1-8b-instant":{llm:"Groq",alias:"llama-3.1-8b-instant",components:["PromptGenerator","LLMAssistant"],tags:["new"]},"llama-3.1-8b-instant":{llm:"Groq",tokens:8e3,completionTokens:8e3,enabled:!1,keyOptions:{tokens:131072,completionTokens:131072,enabled:!0}},"llama3-groq-70b-tool-use-preview":{llm:"Groq",tokens:8192,completionTokens:8192,enabled:!1,keyOptions:{tokens:8192,completionTokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["new"]},"llama3-groq-8b-tool-use-preview":{llm:"Groq",tokens:8192,completionTokens:8192,enabled:!1,keyOptions:{tokens:8192,completionTokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["new"]},"groq-llama3-8b":{llm:"Groq",alias:"llama3-8b-8192",components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"llama3-8b-8192":{llm:"Groq",tokens:1024,completionTokens:1024,enabled:!1,keyOptions:{tokens:8192,completionTokens:8192,enabled:!0}},"groq-llama3-70b":{llm:"Groq",alias:"llama3-70b-8192",components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"llama3-70b-8192":{llm:"Groq",tokens:1024,completionTokens:1024,enabled:!1,keyOptions:{tokens:8192,completionTokens:8192,enabled:!0}},"groq-llama2-70b":{llm:"Groq",alias:"llama2-70b-4096",components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"llama2-70b-4096":{llm:"Groq",tokens:1024,completionTokens:1024,enabled:!1,keyOptions:{tokens:4096,completionTokens:4096,enabled:!0}},"groq-mixtral-8x7b":{llm:"Groq",alias:"mixtral-8x7b-32768",components:["PromptGenerator","LLMAssistant"]},"mixtral-8x7b-32768":{llm:"Groq",tokens:1024,completionTokens:1024,enabled:!1,keyOptions:{tokens:32768,completionTokens:32768,enabled:!0}},"groq-gemma-7b":{llm:"Groq",alias:"gemma-7b-it",components:["PromptGenerator","LLMAssistant"]},"gemma-7b-it":{llm:"Groq",tokens:1024,completionTokens:1024,enabled:!1,keyOptions:{tokens:8192,completionTokens:8192,enabled:!0}},"zero-one-ai/Yi-34B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["LLMAssistant"]},"Austism/chronos-hermes-13b":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo":{llm:"togetherAI",tokens:4096,enabled:!1,keyOptions:{tokens:128e3,enabled:!0},components:["LLMAssistant","PromptGenerator"]},"meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo":{llm:"togetherAI",tokens:4096,enabled:!1,keyOptions:{tokens:128e3,enabled:!0},components:["LLMAssistant","PromptGenerator"]},"meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo":{llm:"togetherAI",tokens:4096,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["LLMAssistant","PromptGenerator"]},"meta-llama/Meta-Llama-3-8B-Instruct-Turbo":{llm:"togetherAI",tokens:4096,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["LLMAssistant","PromptGenerator"]},"meta-llama/Meta-Llama-3-70B-Instruct-Turbo":{llm:"togetherAI",tokens:4096,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["LLMAssistant","PromptGenerator"]},"meta-llama/Meta-Llama-3-8B-Instruct-Lite":{llm:"togetherAI",tokens:4096,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["LLMAssistant","PromptGenerator"]},"meta-llama/Meta-Llama-3-70B-Instruct-Lite":{llm:"togetherAI",tokens:4096,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["LLMAssistant","PromptGenerator"]},"togethercomputer/CodeLlama-13b-Instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0}},"codellama/CodeLlama-13b-Instruct-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"togethercomputer/CodeLlama-34b-Instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0}},"codellama/CodeLlama-34b-Instruct-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"codellama/CodeLlama-70b-Instruct-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"togethercomputer/CodeLlama-7b-Instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0}},"codellama/CodeLlama-7b-Instruct-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:16384,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"togethercomputer/llama-2-70b-chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0}},"meta-llama/Llama-2-70b-chat-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"togethercomputer/llama-2-13b-chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0}},"meta-llama/Llama-2-13b-chat-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["LLMAssistant"]},"togethercomputer/llama-2-7b-chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0}},"meta-llama/Llama-2-7b-chat-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["LLMAssistant"]},"meta-llama/Llama-3-8b-chat-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"meta-llama/Llama-3-70b-chat-hf":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"DiscoResearch/DiscoLM-mixtral-8x7b-v2":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0}},"togethercomputer/falcon-40b-instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0}},"togethercomputer/falcon-7b-instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"togethercomputer/GPT-NeoXT-Chat-Base-20B":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0}},"togethercomputer/Llama-2-7B-32K-Instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0}},"mistralai/Mistral-7B-Instruct-v0.1":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"mistralai/Mistral-7B-Instruct-v0.2":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"mistralai/Mistral-7B-Instruct-v0.3":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant","Classifier"],tags:["legacy"]},"mistralai/Mixtral-8x7B-Instruct-v0.1":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant","Classifier"]},"mistralai/Mixtral-8x22B-Instruct-v0.1":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:65536,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Gryphe/MythoMax-L2-13b":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"NousResearch/Nous-Hermes-Llama2-70b":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0}},"NousResearch/Nous-Capybara-7B-V1p9":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"NousResearch/Nous-Hermes-2-Mistral-7B-DPO":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"NousResearch/Nous-Hermes-2-Mixtral-8x7B-DPO":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"NousResearch/Nous-Hermes-2-Mixtral-8x7B-SFT":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"NousResearch/Nous-Hermes-2-Yi-34B":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"NousResearch/Nous-Hermes-llama-2-7b":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"NousResearch/Nous-Hermes-Llama2-13b":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"openchat/openchat-3.5-1210":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"teknium/OpenHermes-2-Mistral-7B":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"teknium/OpenHermes-2p5-Mistral-7B":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"garage-bAInd/Platypus2-70B-instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"togethercomputer/Pythia-Chat-Base-7B-v0.16":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0}},"togethercomputer/Qwen-7B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0}},"togethercomputer/RedPajama-INCITE-Chat-3B-v1":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0}},"togethercomputer/RedPajama-INCITE-7B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0}},"upstage/SOLAR-0-70b-16bit":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0}},"upstage/SOLAR-10.7B-Instruct-v1.0":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"togethercomputer/StripedHyena-Nous-7B":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"lmsys/vicuna-7b-v1.5":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"lmsys/vicuna-13b-v1.5":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"lmsys/vicuna-13b-v1.5-16k":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:16384,enabled:!0}},"allenai/OLMo-7B-Twin-2T":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"allenai/OLMo-7B":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Qwen/Qwen1.5-0.5B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["LLMAssistant"],tags:["legacy"]},"Qwen/Qwen1.5-1.8B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Qwen/Qwen1.5-4B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Qwen/Qwen1.5-7B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Qwen/Qwen1.5-14B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Qwen/Qwen1.5-32B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Qwen/Qwen1.5-72B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Qwen/Qwen1.5-110B-Chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"deepseek-ai/deepseek-coder-33b-instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:16384,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"deepseek-ai/deepseek-llm-67b-chat":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"google/gemma-2b-it":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"google/gemma-7b-it":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Undi95/ReMM-SLERP-L2-13B":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0}},"Undi95/Toppy-M-7B":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"cognitivecomputations/dolphin-2.5-mixtral-8x7b":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"databricks/dbrx-instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"Open-Orca/Mistral-7B-OpenOrca":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:8192,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"snorkelai/Snorkel-Mistral-PairRM-DPO":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:32768,enabled:!0},components:["LLMAssistant"],tags:["legacy"]},"Snowflake/snowflake-arctic-instruct":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"],tags:["legacy"]},"togethercomputer/alpaca-7b":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:2048,enabled:!0},components:["PromptGenerator","LLMAssistant"]},"WizardLM/WizardLM-13B-V1.2":{llm:"togetherAI",tokens:1024,enabled:!1,keyOptions:{tokens:4096,enabled:!0},components:["PromptGenerator","LLMAssistant"]}},Dt=Object.defineProperty,qt=(e,t,s)=>((e,t,s)=>t in e?Dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class $t{constructor(e){this.model=e,qt(this,"_llmConnector"),qt(this,"_modelId"),qt(this,"_modelInfo");const t=Mt[e]?.llm;this._modelId=Mt[e]?.alias||e,this._modelInfo=Mt[this._modelId],this._llmConnector=Te.getLLMConnector(t)}static load(e){return new $t(e)}get modelInfo(){return this._modelInfo}get connector(){return this._llmConnector}async promptRequest(e,t={},s,n={}){if(!this._llmConnector)return{error:"LLM request failed",details:`Model ${this.model} not supported`};const o=s instanceof Qs?s.id:s,r=await this._llmConnector.extractLLMComponentParams(t);r.model=this._modelId,Object.assign(r,n);try{e=this._llmConnector.enhancePrompt(e,t);let s=await this._llmConnector.user(Ye.agent(o)).chatRequest(e,r);const n=this._llmConnector.postProcess(s?.content);return n.error&&"stop"!==s.finishReason&&(n.details="The model stopped before completing the response, this is usually due to output token limit reached."),n}catch(e){return{error:"LLM request failed",details:e?.message||e?.toString()}}}async visionRequest(e,t,s={},n){const o=n instanceof Qs?n.id:n,r=await this._llmConnector.extractVisionLLMParams(s);r.model=this._modelId,r.sources=t;try{e=this._llmConnector.enhancePrompt(e,s);let t=await this._llmConnector.user(Ye.agent(o)).visionRequest(e,r);const n=this._llmConnector.postProcess(t?.content);return n.error&&"stop"!==t.finishReason&&(n.details="The model stopped before completing the response, this is usually due to output token limit reached."),n}catch(e){return{error:"LLM request failed",details:e?.message||e?.toString()}}}async toolRequest(e,t){const s=t instanceof Qs?t.id:t;return this._llmConnector.user(Ye.agent(s)).toolRequest(e)}async streamToolRequest(e,t){const s=t instanceof Qs?t.id:t;return this._llmConnector.user(Ye.agent(s)).streamToolRequest(e)}async streamRequest(e,t){const s=t instanceof Qs?t.id:t;return this._llmConnector.user(Ye.agent(s)).streamRequest(e)}}var Nt=Object.defineProperty,jt=(e,t,s)=>((e,t,s)=>t in e?Nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class Gt extends yt{constructor(){super(),jt(this,"configSchema",c.object({model:c.string().max(200).required(),prompt:c.string().required().label("Prompt"),temperature:c.number().min(0).max(5).label("Temperature"),maxTokens:c.number().min(1).label("Maximum Tokens"),stopSequences:c.string().allow("").max(400).label("Stop Sequences"),topP:c.number().min(0).max(1).label("Top P"),topK:c.number().min(0).max(500).label("Top K"),frequencyPenalty:c.number().min(0).max(2).label("Frequency Penalty"),presencePenalty:c.number().min(0).max(2).label("Presence Penalty")}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);try{n.debug("=== LLM Prompt Log ===");const o=t.data.model||"echo",r=$t.load(o);if(!r.connector)return{_error:`The model '${o}' is not available. Please try a different one.`,_debug:n.output};n.debug(` Model : ${o}`);let a=vt(t.data.prompt).parse(e).result;n.debug(" Parsed prompt\n",a,"\n");const i=await r.promptRequest(a,t,s).catch((e=>({error:e})));if(n.debug(" Enhanced prompt \n",a,"\n"),!i)return{_error:" LLM Error = Empty Response!",_debug:n.output};if(i?.error)return n.error(` LLM Error=${JSON.stringify(i.error)}`),{Reply:i?.data,_error:i?.error+" "+i?.details,_debug:n.output};const l={Reply:i};return l._debug=n.output,l}catch(e){return{_error:e.message,_debug:n.output}}}}var Bt=Object.defineProperty,Vt=(e,t,s)=>((e,t,s)=>t in e?Bt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);var Ut=Object.defineProperty,Ft=(e,t,s)=>((e,t,s)=>t in e?Ut(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);var Kt=Object.defineProperty,Jt=(e,t,s)=>((e,t,s)=>t in e?Kt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class zt{static load(e){throw new Error("Method not implemented.")}}var Wt=Object.defineProperty,Ht=(e,t,s)=>((e,t,s)=>t in e?Wt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class Qt{constructor(){Ht(this,"_connector"),Ht(this,"embeddingsProvider"),Ht(this,"_vectorDimention"),this._connector=Te.getVectorDBConnector(),this.embeddingsProvider=new f,this._vectorDimention&&!isNaN(this._vectorDimention)&&(this.embeddingsProvider.dimensions=this._vectorDimention)}static load(e={}){const t=new Qt;return e.vectorDimention&&t.setVectorDimention(e.vectorDimention),t}setVectorDimention(e){this._vectorDimention=e}static async chunkText(e,{chunkSize:t=4e3,chunkOverlap:s=500}={}){return await new y({chunkSize:t,chunkOverlap:s}).splitText(e)}async ingestText(e,t,{teamId:s,metadata:n,chunkSize:o=4e3,chunkOverlap:r=500}={}){const a=await Qt.chunkText(e,{chunkSize:o,chunkOverlap:r}),i=Array.from({length:a.length},((e,t)=>g.randomUUID())),l=a.map(((e,t)=>({id:i[t],source:e,metadata:{user:Qt.stringifyMetadata(n)}})));return await this._connector.user(Ye.team(s)).insert(t,l)}async embedText(e){return this.embeddingsProvider.embedQuery(e)}async embedTexts(e){return this.embeddingsProvider.embedDocuments(e)}static stringifyMetadata(e){try{return h(JSON.stringify(e))}catch{return e}}}var Yt=Object.defineProperty,Xt=(e,t,s)=>((e,t,s)=>t in e?Yt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);var Zt=Object.defineProperty,es=(e,t,s)=>((e,t,s)=>t in e?Zt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);var ts=Object.defineProperty,ss=(e,t,s)=>((e,t,s)=>t in e?ts(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);var ns=Object.defineProperty,os=(e,t,s)=>((e,t,s)=>t in e?ns(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);function rs(e){return(t,s)=>{const n=Number(t),o=s.schema._flags.label||s.state.path[s.state.path.length-1];if(isNaN(n))throw new Error(`The value for '${o}' must be a number`);if(void 0!==e.min&&void 0!==e.max){if(n<e.min||n>e.max)throw new Error(`The value for '${o}' must be from ${e.min} to ${e.max}`)}else if(void 0!==e.min){if(n<e.min)throw new Error(`The value for '${o}' must be greater or equal to ${e.min}`)}else if(void 0!==e.max&&n>e.max)throw new Error(`The value for '${o}' must be less or equal to ${e.max}`);return t}}var as=Object.defineProperty,is=(e,t,s)=>((e,t,s)=>t in e?as(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);function ls(e){return(t,s)=>{const n=Number(t),o=s.schema._flags.label||s.state.path[s.state.path.length-1];if(isNaN(n))throw new Error(`The value for '${o}' must be a number`);if(void 0!==e.min&&void 0!==e.max){if(n<e.min||n>e.max)throw new Error(`The value for '${o}' must be from ${e.min} to ${e.max}`)}else if(void 0!==e.min){if(n<e.min)throw new Error(`The value for '${o}' must be greater or equal to ${e.min}`)}else if(void 0!==e.max&&n>e.max)throw new Error(`The value for '${o}' must be less or equal to ${e.max}`);return t}}var cs=Object.defineProperty,us=(e,t,s)=>((e,t,s)=>t in e?cs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class ms{constructor(e){this.agentData=e,us(this,"agent"),us(this,"_loadPromise"),this.initAgent(e)}async initAgent(e){let t,s;if("object"==typeof e)t=e,t.components&&t.connections&&(t={data:t,version:"1.0"}),s=t.data.id||"tmp-"+F();else{const n=/^{.*}$/g,o=e.match(n)?.[0],r=/^[a-zA-Z0-9\-]+$/g;s=e.match(r)?.[0],s&&(t=await Te.getAgentDataConnector().getAgentData(s,"latest")),!t&&o&&(t=JSON.parse(o),s=t.id||"tmp-"+F(),t.components&&t.connections&&(t={data:t,version:"1.0"}))}const n=new $e(s);this.agent=new Qs(s,t,n)}async ready(){return this._loadPromise?this._loadPromise:this._loadPromise=new Promise((e=>{let t=1e4;const s=setInterval((()=>{this.agent&&(clearInterval(s),e(!0)),t-=100,t<=0&&(clearInterval(s),e(!1))}),100)}))}static load(e){return new ms(e)}async run(e){if(await this.ready(),!this.agent)throw new Error("Failed to load agent");let t=this.parseReqConfig(e);this.agent.setRequest(t);const s=t.path.match(/(^\/v[0-9]+\.[0-9]+?)?(\/api\/(.+)?)/);if(!s||!s[2])return{status:404,data:{error:"Endpoint not found"}};const n=s[2],o="GET"==t.method?t.query:t.body;return{data:await this.agent.process(n,o).catch((e=>({error:e.message})))}}reset(){this.initAgent(this.agentData)}parseReqConfig(e){return e instanceof B?e:Array.isArray(e)?this.parseCLI(e):new B(e)}parseCLI(e){const t=Te.getCLIConnector().parse(e,["endpoint","post","get","put","delete","patch","head","options","headers","session"]),s=["get","post","put","delete","patch","head","options"].find((e=>t[e])),o=new B;switch(o.method=s?.toUpperCase()||"GET",o.body={},o.query={},s){case"get":case"delete":case"head":case"options":o.query=t[s];break;case"post":case"put":case"patch":o.body=t[s]}o.path=`/api/${t.endpoint}`,o.params=t.endpoint?.split("/"),o.headers=t.headers||{};for(let e in o.headers)o.headers[e.toLowerCase()]=o.headers[e],delete o.headers[e];if(o.sessionID=t.session||F(),o.files=[],o.body)for(let e in o.body){let t=o.body[e];const s=w.join(process.cwd(),t),r=w.basename(s);if(b.existsSync(s))try{const t=b.readFileSync(s),a=r.split(".").pop(),i={fieldname:e,originalname:r,buffer:t,mimetype:p.getType(a)||"application/octet-stream"};delete o.body[e],o.files.push(i),n.fileTypeFromBuffer(t).then((e=>{e&&(i.mimetype=e.mime)}))}catch(e){console.warn("Coud not read file",s,e.message)}}return o}async post(e,t,s){return this.run({method:"POST",path:e,body:t||{},headers:s})}async get(e,t,s){return this.run({method:"GET",path:e,query:t,headers:s})}}var ps=Object.defineProperty,ds=(e,t,s)=>((e,t,s)=>t in e?ps(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class hs{constructor(e,t="",s=[]){this._model=e,this._systemPrompt=t,this._messages=s,ds(this,"_llmHelper"),ds(this,"contextLength"),this._llmHelper=$t.load(this._model)}get llmHelper(){return this._llmHelper}get messages(){return this._messages}push(...e){this._messages.push(...e)}addUserMessage(e){this.push({role:"user",content:e})}getContextWindow(e,t=256){const s=this._llmHelper?.modelInfo?.keyOptions?.tokens||this._llmHelper?.modelInfo?.tokens||256;let n=Math.min(e,s);n+t>s&&(n-=n+t-s);let o=[];const r={role:"system",content:this._systemPrompt};let a=A([r],"gpt-4o").length;for(let e=this._messages.length-1;e>=0;e--){const t=this._messages[e];if("system"===t.role)continue;if(!t.content){o.unshift(t);continue}delete t.__smyth_data__;const s="string"==typeof t.content?t.content:JSON.stringify(t.content),r=k(s);if(a+=r.length,a>n){if("string"!=typeof t.content)break;const e=(a-n)/r.length;t.content=t.content.slice(0,Math.floor(t.content.length*(1-e))-200),t.content+="...\n\nWARNING : The context window has been truncated to fit the maximum token limit.",a-=r.length,a+=A([t],"gpt-4").length}o.unshift(t)}return o.unshift(r),o}}const gs=["GET","POST","PUT","PATCH","DELETE","HEAD","OPTIONS"];var fs=(e=>(e.ChatBot="chatBot",e.ChatGPT="chatGPT",e))(fs||{});const ys=2048,bs="gpt-3.5-turbo",ws="\nAll responses should be in valid JSON format, compacted without newlines, indentations, or additional JSON syntax markers.",As=new _;class ks{static mapReqMethods(e){const t=new Map;for(const s in e){const n=e[s];for(const e in n){const s=n[e];gs.includes(e.toUpperCase())&&t.set(s?.operationId,e)}}return t}static mapEndpoints(e){const t=new Map;for(const s in e){const n=e[s];for(const e in n){const o=n[e];gs.includes(e.toUpperCase())&&t.set(o?.operationId,s)}}return t}static async yamlToJson(e){const t=x.load(e);return await I.dereference(t)}static async getJson(e){try{let t=e;return"string"==typeof e&&(t=JSON.parse(t)),As.dereference(t)}catch{try{return ks.yamlToJson(e)}catch{throw new Error("Invalid OpenAPI specification data format")}}}static async getJsonFromUrl(e){const t=(await r.get(e)).data;return ks.getJson(t)}static isValidOpenAPI(e){return e?.openapi&&e?.paths&&e?.servers}}var xs=Object.defineProperty,_s=(e,t,s)=>((e,t,s)=>t in e?xs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const Is=ye("ConversationHelper");class vs extends i{constructor(e,t,s){super(),this._model=e,this._specSource=t,this._settings=s,_s(this,"_agentId",""),_s(this,"systemPrompt"),_s(this,"assistantName"),_s(this,"_reqMethods"),_s(this,"_toolsConfig"),_s(this,"_endpoints"),_s(this,"_baseUrl"),_s(this,"_status",""),_s(this,"_currentWaitPromise"),_s(this,"_context"),_s(this,"_maxContextSize",16384),_s(this,"_maxOutputTokens",1024),_s(this,"_spec"),s?.maxContextSize&&(this._maxContextSize=s.maxContextSize),s?.maxOutputTokens&&(this._maxOutputTokens=s.maxOutputTokens),t?this.loadSpecFromSource(t).then((e=>{if(!e)throw this._status="error",this.emit("error","Invalid OpenAPI specification data format"),new Error("Invalid OpenAPI specification data format");this._spec=e,this.updateModel(this._model),this._status="ready"})):(this.updateModel(this._model),this._status="ready")}get context(){return this._context}set spec(e){this.ready.then((()=>{this._status="",this.loadSpecFromSource(e).then((e=>{if(!e)throw this._status="error",this.emit("error","Invalid OpenAPI specification data format"),new Error("Invalid OpenAPI specification data format");this._spec=e,this.updateModel(this._model),this._status="ready"}))}))}set model(e){this.ready.then((()=>{this._status="",this.updateModel(e),this._status="ready"}))}get model(){return this._model}get ready(){return this._currentWaitPromise||(this._currentWaitPromise=new Promise(((e,t)=>{if(this._status)return e(!0);let s=0;const n=setInterval((()=>this._status?(clearInterval(n),e(!0)):(s+=100,s>=3e4?(clearInterval(n),t("Timeout: Failed to prepare data")):void 0)),100)}))),this._currentWaitPromise}async prompt(e,t={}){await this.ready;const s=this._reqMethods,n=this._toolsConfig,o=this._endpoints,r=this._baseUrl;Is.debug("Request to LLM with the given model, messages and functions properties.",{model:this.model,message:e,toolsConfig:n});const a=$t.load(this.model);e&&this._context.addUserMessage(e);const i=this._context.getContextWindow(this._maxContextSize,this._maxOutputTokens),{data:l,error:c}=await a.toolRequest({model:this.model,messages:i,toolsConfig:n,max_tokens:this._maxOutputTokens},this._agentId);if(c)throw new Error("[LLM Request Error]\n"+JSON.stringify({code:c?.name||"LLMRequestFailed",message:c?.message||"Something went wrong while calling LLM."}));if(l?.useTool){Is.debug({type:"ToolsData",message:"Tool(s) is available for use.",toolsData:l?.toolsData});const e=[];for(const n of l?.toolsData){const a=o?.get(n?.name),i=pt(n?.arguments).tryParse();let l="string"==typeof n?.arguments?i||{}:n?.arguments;if(l?.error)throw new Error("[Tool] Arguments Parsing Error\n"+JSON.stringify({message:l?.error}));const c={type:n?.type,method:s?.get(n?.name),endpoint:a,args:l,baseUrl:r,headers:t};Is.debug({type:"UseTool",message:"As LLM returned a tool to use, so use it with the provided arguments.",plugin_url:{baseUrl:r,endpoint:a,args:l},arguments:l}),this.emit("beforeToolCall",c);let{data:u,error:m}=await this.useTool(c);m&&(this.emit("toolCallError",c,m),u="object"==typeof m&&null!==typeof m?JSON.stringify(m):m),u="object"==typeof u&&null!==typeof u?JSON.stringify(u):u,Is.debug({type:"ToolResult",message:"Result from the tool",response:u}),this.emit("afterToolCall",c,u),e.push({...n,result:u})}const n=a.connector.prepareInputMessageBlocks({messageBlock:l?.message,toolsData:e});return this._context.push(...n),this.prompt(null,t)}let u=pt(l?.content).tryParse();return Is.debug({type:"FinalResult",message:"Here is the final result after processing all the tools and LLM response.",response:u}),u}async streamPrompt(e,t={},s=4){await this.ready;let n="";const o=this._reqMethods,r=this._toolsConfig,a=this._endpoints,i=this._baseUrl,l=$t.load(this.model);e&&this._context.addUserMessage(e);const c=this._context.getContextWindow(this._maxContextSize,this._maxOutputTokens),u=await l.streamRequest({model:this.model,messages:c,toolsConfig:r,max_tokens:this._maxOutputTokens},this._agentId).catch((e=>{Is.error("Error on streamRequest: ",e)}));if(!u||u.error)throw new Error("[LLM Request Error]");e&&this.emit("start"),u.on("data",(e=>{this.emit("data",e)})),u.on("content",(e=>{n+=e,this.emit("content",e)}));const m=await new Promise(((e,r)=>{let c=!1;u.on("toolsData",(async r=>{c=!0;let u={role:"assistant",content:n,tool_calls:[]};u.tool_calls=r.map((e=>({id:e.id,type:e.type,function:{name:e.name,arguments:e.arguments}}))),this.emit("toolInfo",r);const m=r.map((e=>async()=>{const s=a?.get(e?.name);let n="string"==typeof e?.arguments?pt(e?.arguments).tryParse()||{}:e?.arguments;if(n?.error)throw new Error("[Tool] Arguments Parsing Error\n"+JSON.stringify({message:n?.error}));this.emit("beforeToolCall",{tool:e,args:n});const r={type:e?.type,method:o?.get(e?.name),endpoint:s,args:n,baseUrl:i,headers:t};let{data:l,error:c}=await this.useTool(r);return c&&(l="object"==typeof c&&null!==typeof c?JSON.stringify(c):c),l="object"==typeof l&&null!==typeof l?JSON.stringify(l):l,this.emit("afterToolCall",{tool:e,args:n},l),{...e,result:l}})),p=await K(m,s),d=l.connector.prepareInputMessageBlocks({messageBlock:u,toolsData:p});this._context.push(...d),e(await this.streamPrompt(null,t,s))})),u.on("end",(async t=>{c||e("")}))}));n+=m;let p=pt(n).tryParse();return e&&(this._context.push({role:"assistant",content:p}),this.emit("end")),p}async _streamPrompt(e,t={},s=4){await this.ready;const n=this._reqMethods,o=this._toolsConfig,r=this._endpoints,a=this._baseUrl,i=$t.load(this.model);e&&this._context.addUserMessage(e);const l=this._context.getContextWindow(this._maxContextSize,this._maxOutputTokens),{data:c,error:u}=await i.streamToolRequest({model:this.model,messages:l,toolsConfig:o},this._agentId);if(u)throw new Error("[LLM Request Error]\n"+JSON.stringify({code:u?.name||"LLMRequestFailed",message:u?.message||"Something went wrong while calling LLM."}));if(c?.useTool){const e=c?.message,o=c?.toolsData;this.emit("toolInfo",o);const l=o.map((e=>async()=>{const s=r?.get(e?.name);let o="string"==typeof e?.arguments?pt(e?.arguments).tryParse()||{}:e?.arguments;if(o?.error)throw new Error("[Tool] Arguments Parsing Error\n"+JSON.stringify({message:o?.error}));this.emit("beforeToolCall",{tool:e,args:o});const i={type:e?.type,method:n?.get(e?.name),endpoint:s,args:o,baseUrl:a,headers:t};let{data:l,error:c}=await this.useTool(i);return c&&(l="object"==typeof c&&null!==typeof c?JSON.stringify(c):c),l="object"==typeof l&&null!==typeof l?JSON.stringify(l):l,this.emit("afterToolCall",{tool:e,args:o},l),{...e,result:l}})),u=await K(l,s),m=i.connector.prepareInputMessageBlocks({messageBlock:e,toolsData:u});return this._context.push(...m),this.streamPrompt(null,t,s)}let m="";if(c.content&&(m=c.content),c.stream){this.emit("start");for await(const e of c.stream){const t=e.choices[0].delta;this.emit("data",t),t.content&&this.emit("content",t.content),m+=t.content||""}this.emit("end")}return pt(m).tryParse()}resolveToolEndpoint(e,t,s,n){let o={};if(n){const e=this._spec?.paths?.[s]?.[t.toLowerCase()]?.parameters||[];for(let t of e)"path"===t.in&&(o[t.name]=n[t.name]||"",delete n[t.name])}const r=vt(s).parse(o,kt.singleCurly).clean().result,a=new URL(r,e);return Object.keys(n).forEach((e=>{a.searchParams.append(e,n[e])})),a.toString()}async useTool(e){const{type:t,endpoint:s,args:n,method:o,baseUrl:a,headers:i={}}=e;if("function"===t)try{const e={method:o,url:this.resolveToolEndpoint(a,o,s,"get"==o?n:{}),headers:i};return"get"!==o&&(Object.keys(n).length&&(e.data=n),e.headers["Content-Type"]="application/json"),Is.debug("Calling tool: ",e),e.url.includes("localhost")?{data:(await ms.load(e.headers["X-AGENT-ID"]).run(e)).data,error:null}:{data:(await r.request(e)).data,error:null}}catch(e){return Is.warn("Failed to call Tool: ",a,s),Is.warn("  ====>",e),{data:null,error:e?.response?.data||e?.message}}return{data:null,error:`'${t}' tool type not supported at the moment`}}updateModel(e){if(this._model=e,this._spec){this._reqMethods=ks.mapReqMethods(this._spec?.paths),this._endpoints=ks.mapEndpoints(this._spec?.paths),this._baseUrl=this._spec?.servers?.[0].url;const e=this.getFunctionDeclarations(this._spec),t=$t.load(this._model);this._toolsConfig=t.connector.formatToolsConfig({type:"function",toolDefinitions:e,toolChoice:"auto"});let s=[];this._context&&(s=this._context.messages),this._context=new hs(this._model,this.systemPrompt,s)}else this._toolsConfig=null,this._reqMethods=null,this._endpoints=null,this._baseUrl=null}patchSpec(e){const t=e?.paths;for(const e in t){const s=t[e];for(const t in s){const n=s[t];n?.operationId||(n.operationId=e.replace(/\//g,"_").replace(/{|}/g,"").replace(/\./g,"_"))}}return e}async loadSpecFromSource(e){if("object"==typeof e)return ks.isValidOpenAPI(e)?this.patchSpec(e):null;if("string"==typeof e){if(se(e)){const t=await ks.getJsonFromUrl(e);t.info?.description&&(this.systemPrompt=t.info.description),t.info?.title&&(this.assistantName=t.info.title);const s=new URL(e).origin;return t?.servers||(t.servers=[{url:s}]),0==t.servers?.length&&(t.servers=[{url:s}]),this.assistantName&&(this.systemPrompt=`Assistant Name : ${this.assistantName}\n\n${this.systemPrompt}`),this.patchSpec(t)}const t=Te.getAgentDataConnector(),s=e,n=await t.getAgentData(s).catch((e=>null));if(!n)return null;this._agentId=s,this.systemPrompt=n?.data?.behavior||this.systemPrompt,this.assistantName=n?.data?.name||n?.data?.templateInfo?.name||this.assistantName,this.assistantName&&(this.systemPrompt=`Assistant Name : ${this.assistantName}\n\n${this.systemPrompt}`);const o=await t.getOpenAPIJSON(n,"http://localhost/","latest",!0).catch((e=>null));return this.patchSpec(o)}}getFunctionDeclarations(e){const t=e?.paths,s=ks.mapReqMethods(t);let n=[];for(const e in t){const o=t[e];for(const e in o){const t=o[e];let r={},a=[];if("get"===(s.get(t?.operationId)||"get").toLowerCase()){const e=t?.parameters||[];for(const t of e)r[t.name]={...t.schema,description:t.description},!0===t.required&&a.push(t?.name||"")}else{r=t?.requestBody?.content?.["application/json"]?.schema?.properties,a=t?.requestBody?.content?.["application/json"]?.schema?.required;for(const e in r)delete r[e]?.required}r||(r={}),a||(a=[]);const i={name:t?.operationId,description:t?.description||t?.summary||"",properties:r,requiredFields:a};n.push(i)}}return n}}var Cs=Object.defineProperty,Ls=(e,t,s)=>((e,t,s)=>t in e?Cs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);var Ps=Object.defineProperty,Os=(e,t,s)=>((e,t,s)=>t in e?Ps(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);let Ts;function Rs(){return Ts||(Ts=Te.getCacheConnector()),Ts}const Ss={Component:new yt,Note:new yt,APIEndpoint:new class extends yt{constructor(){super(),Lt(this,"configSchema",c.object({endpoint:c.string().pattern(/^[a-zA-Z0-9]+([-_][a-zA-Z0-9]+)*$/).max(50).required(),method:c.string().valid("POST","GET").allow(""),description:c.string().max(5e3).allow(""),summary:c.string().max(1e3).allow(""),doc:c.string().max(1e3).allow(""),ai_exposed:c.boolean().default(!0)}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=s.agentRequest,o=this.createComponentLogger(s,t.name),r=n?n.headers:{};let a=n?n.body:e;const i=n?n.params:{};let l=n?n.query:{};const c=n?n._agent_authinfo:void 0;for(const[t,n]of Object.entries(a))Tt(n)?a[t]=await Rt(n,s?.teamId):Ot(n)&&(a[t]=vt(n).parse(e).result);for(const[t,n]of Object.entries(l))Tt(n)?l[t]=await Rt(n,s?.teamId):Ot(n)&&(l[t]=vt(n).parse(e).result);const u=t.inputs.filter((e=>void 0!==e.defaultVal&&""!==e.defaultVal&&null!==e.defaultVal)),m=[],p=[];for(const e of t.outputs){const t=e?.expression||e?.name,s=t?.split(".")[1];s&&(t?.includes("body")&&m.push(s),t?.includes("query")&&p.push(s))}for(const t of u){const s=t?.name;let n=e[s];m.includes(s)&&Pt(a[s])&&(a[s]=n),p.includes(s)&&Pt(l[s])&&(l[s]=n)}if(void 0!==n.header("X-Debug-Inj")&&s.agentRuntime.debug&&Object.values(e).length>0)if("GET"===t.data.method)for(const[t,s]of Object.entries(e))s instanceof lt?o.debug("[WARNING] Binary files are not supported for GET requests. Key:",t):l[t]=s;else a=e;a=await ht(a,t.inputs,s),l=await ht(l,t.inputs,s),o.debug("Parsing inputs"),o.debug(" Headers",r),o.debug(" Body",a),o.debug(" Params",i),o.debug(" Query",l),o.debug("Parsing body json input");for(let e in a){const t=a[e];if("string"==typeof t&&t.trim().startsWith("{")&&t.trim().endsWith("}"))try{const t=JSON.parse(h(a[e]));a[e]=t}catch{}}o.debug("Parsed body json input",a),o.debug("Parsing query json input");for(let e in l){const t=l[e];if("string"==typeof t&&t.trim().startsWith("{")&&t.trim().endsWith("}"))try{const t=JSON.parse(h(l[e]));l[e]=t}catch{}}o.debug("Parsed query json input",l);for(let e of t.inputs){if(!e.isFile&&"binary"!==e?.type?.toLowerCase())continue;const t=e.name;o.debug("Parsing file input ",t);let r=a[t];if(!(r instanceof lt)&&n.files?.length>0){const e=n.files.find((e=>e.fieldname===t));if(!e)continue;r=new lt(e.buffer,F()+"-"+e.originalname,e.mimetype)}r instanceof lt&&(a[t]=await r.getJsonData(Ye.agent(s.id)))}return{headers:r,body:a,query:l,params:i,_authInfo:c,_debug:o.output}}},APIOutput:new class extends yt{constructor(){super(),Et(this,"configSchema",c.object({format:c.string().valid("full","minimal").required().label("Output Format")})),Et(this,"hasPostProcess",!0)}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name),o={};n.debug(" Processing outputs ");for(let t in e)o[t]=e[t];return{Output:o,_error:void 0,_debug:n.output}}async postProcess(e,t,s){for(let t in s.agentVariables)delete e?.result?.Output?.[t];if("minimal"==t?.data?.format){if(e?.result?.Output)return e?.result?.Output;if(e?.result?._error)return e?.result?._error;delete e.id,delete e.name}return e}},PromptGenerator:new Gt,LLMPrompt:new Gt,APICall:new class extends yt{constructor(){super(),Vt(this,"configSchema",c.object({method:c.string().valid("GET","POST","PUT","PATCH","DELETE","HEAD").required().label("Method"),url:c.string().max(8192).required().label("URL"),headers:c.string().allow("").label("Headers"),contentType:c.string().valid("none","application/json","multipart/form-data","binary","application/x-www-form-urlencoded","text/plain","application/xml").label("Content-Type"),body:c.string().allow("").label("Body"),_templateSettings:c.object().allow(null).label("Template Settings"),_templateVars:c.object().allow(null).label("Template Variables"),proxy:c.string().allow("").label("Proxy"),oauthService:c.string().allow("").label("OAuth Service"),scope:c.string().allow("").label("Scope"),authorizationURL:c.string().allow("").label("Authorization URL"),tokenURL:c.string().allow("").label("Token URL"),clientID:c.string().allow("").label("Client ID"),clientSecret:c.string().allow("").label("Client Secret"),oauth2CallbackURL:c.string().allow("").label("OAuth2 Callback URL"),callbackURL:c.string().allow("").label("Callback URL"),requestTokenURL:c.string().allow("").label("Request Token URL"),accessTokenURL:c.string().allow("").label("Access Token URL"),userAuthorizationURL:c.string().allow("").label("User Authorization URL"),consumerKey:c.string().allow("").label("Consumer Key"),consumerSecret:c.string().allow("").label("Consumer Secret"),oauth1CallbackURL:c.string().allow("").label("OAuth1 Callback URL"),authenticate:c.string().allow("").label("Authenticate")}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);try{n.debug("=== API Call Log ===");const e={};const s=t?.data?.method||"get";e.method=s;return{Response:{},Headers:{},_error:undefined,_debug:n.output}}catch(e){return{_error:e.message,_debug:n.output}}}},VisionLLM:new class extends yt{constructor(){super(),Ft(this,"configSchema",c.object({prompt:c.string().required().label("Prompt"),maxTokens:c.number().min(1).label("Maximum Tokens"),model:c.string().max(200).required()}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);try{n.debug("=== Vision LLM Log ===");const o=t.data.model||"gpt-4-vision-preview",r=$t.load(o);if(!r.connector)return{_error:`The model '${o}' is not available. Please try a different one.`,_debug:n.output};let a=vt(t.data.prompt).parse(e).result;n.debug(" Parsed prompt\n",a,"\n");const i=[],l=Array.isArray(e.Images)?e.Images:[e.Images],c=[];for(let e of l){const t=lt.from(e);i.push(t),c.push(t.upload(Ye.agent(s.id)))}await Promise.all(c);const u=await r.visionRequest(a,i,t,s);if(n.debug(" Enhanced prompt \n",a,"\n"),!u)return{_error:" LLM Error = Empty Response!",_debug:n.output};if(u?.error)return n.error(` LLM Error=${JSON.stringify(u.error)}`),{Reply:u?.data,_error:u?.error+" "+u?.details,_debug:n.output};const m={Reply:u};return m._debug=n.output,m}catch(e){return{_error:e.message,_debug:n.output}}}},FSleep:new class extends yt{constructor(){super()}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);try{const s=parseInt(t.data.delay||1),o=e.Input;return n.debug(`Sleeping for ${s} seconds`),await new Promise((e=>setTimeout(e,1e3*s))),{Output:o,_error:void 0,_debug:n.output,_debug_time:n.elapsedTime}}catch(e){const t=e?.response?.data||e?.message||e.toString();return n.error(` Error processing data \n${t}\n`),{hash:void 0,_error:t,_debug:n.output,_debug_time:n.elapsedTime}}}},FHash:new class extends yt{constructor(){super()}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);try{const s=e.Data,o=t.data.algorithm,r=t.data.encoding;n.debug(` Generating hash using ${o} algorithm and ${r} encoding`);const a=g.createHash(o);a.update(s);const i=a.digest(r);return n.debug(` Generated hash: ${i}`),{Hash:i,_error:void 0,_debug:n.output}}catch(e){const t=e?.response?.data||e?.message||e.toString();return n.error(` Error generating hash \n${t}\n`),{hash:void 0,_error:t,_debug:n.output}}}},FEncDec:new class extends yt{constructor(){super()}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);try{const s=e.Data,o=t.data.action||"Encode",r=t.data.encoding;return n.debug(`${r} ${o} data`),{Output:"Encode"==o?Buffer.from(s).toString(r):Buffer.from(s,r).toString("utf8"),_error:void 0,_debug:n.output}}catch(e){const t=e?.response?.data||e?.message||e.toString();return n.error(` Error processing data \n${t}\n`),{hash:void 0,_error:t,_debug:n.output}}}},FTimestamp:new class extends yt{constructor(){super()}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);try{t.data.format;const e=Date.now();return n.debug(`Timestamp : ${e}`),{Timestamp:e,_error:void 0,_debug:n.output,_debug_time:n.elapsedTime}}catch(e){const t=e?.response?.data||e?.message||e.toString();return n.error(` Error processing data \n${t}\n`),{hash:void 0,_error:t,_debug:n.output,_debug_time:n.elapsedTime}}}},DataSourceLookup:new class extends yt{constructor(){super(),Jt(this,"configSchema",c.object({topK:c.string().custom(ae({min:0}),"custom range validation").label("Result Count"),model:c.string().valid("gpt-3.5-turbo","gpt-4","gpt-3.5-turbo-16k").required(),prompt:c.string().max(3e4).allow("").label("Prompt"),postprocess:c.boolean().strict().required(),includeMetadata:c.boolean().strict().optional(),namespace:c.string().allow("").max(80).messages({"string.max":"The length of the 'namespace' name must be 50 characters or fewer."})}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=t.id;s.components[n];const o=s.teamId,r={};for(let e of t.outputs)e.default||(r[e.name]="");const a=t.data.namespace,i=t.data.model,l=t.data.prompt?.trim?.()||"",c=t.data.postprocess,u=t.data.includeMetadata||!1,m="string"==typeof e.Query?e.Query:JSON.stringify(e.Query),p=Math.max(t.data.topK,50),d=Te.getVectorDBConnector();let h,g;try{h=(await d.user(Ye.team(o)).search(a,m,{topK:p,includeMetadata:!0})).slice(0,t.data.topK).map((e=>({content:e.metadata?.text,metadata:e.metadata}))),h=u?h.map((e=>({content:e.content,metadata:this.parseMetadata(e.metadata?.user||e.metadata?.metadata)}))):h.map((e=>e.content))}catch(e){g=e.toString()}if(c&&l){const t=[];for(let t of h)vt(l.replace(/{{result}}/g,JSON.stringify(t))).parse(e).result,zt.load(i);h=await Promise.all(t);for(let e=0;e<h.length;e++)"string"==typeof h[e]&&(h[e]=pt(h[e]).tryParse())}return{Results:h,_error:g,_debug:`totalLength = ${JSON.stringify(h).length}`}}parseMetadata(e){try{return JSON.parse(h(e))}catch{return e}}},DataSourceIndexer:new class extends yt{constructor(){super(),Xt(this,"MAX_ALLOWED_URLS_PER_INPUT",20),Xt(this,"configSchema",c.object({namespace:c.string().max(50).allow(""),id:c.string().custom(re,"id custom validation").allow("").label("source identifier"),name:c.string().max(50).allow("").label("label"),metadata:c.string().allow(null).allow("").max(1e4).label("metadata")}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=s.teamId;s.id;let o=s.agentRuntime?.debug?"== Source Indexer Log ==\n":null;try{const s={...t.data,name:vt(t.data.name).parse(e).result,id:vt(t.data.id).parse(e).result,metadata:vt(t.data.metadata).parse(e).result},r={};for(let e of t.outputs)e.default||(r[e.name]=e?.description?`<${e?.description}>`:"");const a=s.namespace;o+=`[Selected namespace id] \n${a}\n\n`;const i=this.validateInput(e);if(i.error)throw new Error(`Input validation error: ${i.error}\n EXITING...`);const l=s.id,c=/^[a-zA-Z0-9\-\_\.]+$/;if(!l)throw new Error("Id is required");if(!c.test(l))throw new Error("Invalid id. Accepted characters: 'a-z', 'A-Z', '0-9', '-', '_', '.'");const u=this.generateContextUID(s.id,n,a);let m=null;//! DISABLE URL ARRAY PARSING FOR NOW UNTIL WE HAVE A GOOD WAY TO HANDLE BULK INDEXING
if(se(i.value.Source))throw o+="STEP: Parsing input as url\n\n",new Error("URLs are not supported yet");return o+="STEP: Parsing input as text\n\n",m=await this.addDSFromText({teamId:n,namespaceId:a,dsId:u,text:i.value.Source,name:s.name||"Untitled",metadata:s.metadata||null}),o+="Created datasource successfully\n\n",{_debug:o,Success:{result:m?.data?.dataSource||!0,id:s.id}}}catch(e){return o+=`Error: ${e?.message||"Couldn't index data source"}\n\n`,{_debug:o,_error:e?.message||"Couldn't index data source"}}}validateInput(e){return c.object({Source:c.any().required()}).unknown(!0).validate(e)}generateContextUID(e,t,s){return`${t}::${s}::${e}`}parseContextUID(e){if(!e)return null;const t=e.split("::");return 3!=t.length?null:{teamId:t[0],agentId:t[1],providedId:t[2]}}async addDSFromText({teamId:e,namespaceId:t,dsId:s,text:n,name:o,metadata:r}){const a=`smythfs://${e}.team/_datasources/${s}.json`,i={namespaceId:t,teamId:e,name:o,metadata:r,text:n,embeddingIds:await Qt.load().ingestText(n,t,{teamId:e,metadata:r})};await rt.Instance.write(a,JSON.stringify(i),Ye.team(e))}async addDSFromUrl({teamId:e,namespaceId:t,dsId:s,type:n,url:o,name:r,metadata:a}){throw new Error("URLs are not supported yet")}},DataSourceCleaner:new class extends yt{constructor(){super(),es(this,"configSchema",c.object({namespaceId:c.string().max(50).allow("").label("namespace"),id:c.string().custom(re,"custom validation characterSet").allow("").label("source identifier")}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=s.teamId;s.id;let o=s.agentRuntime?.debug?"== Source Indexer Log ==\n":null;try{const s=this.validateConfigData(t.data);if(s.error)throw new Error(`Config data validation error: ${s.error}\n EXITING...`);const r={};for(let e of t.outputs)e.default||(r[e.name]=e?.description?`<${e?.description}>`:"");const a=this.validateInput(e);if(a.error)throw new Error(`Input validation error: ${a.error}\n EXITING...`);const i=s.value.namespaceId,l=vt(t.data.id).parse(e).result;if(!/^[a-zA-Z0-9\-\_\.]+$/.test(l))throw new Error("Invalid id. Accepted characters: 'a-z', 'A-Z', '0-9', '-', '_', '.'");o+=`Searching for data source with id: ${l}\n`;const c=`smythfs://${n}.team/_datasources/${this.generateContextUID(l,n,i)}.json`,u=await rt.Instance.read(c,Ye.team(n)),m=mt.create(u.toString()).tryParse();if(!m)throw new Error(`Data source not found with id: ${l}`);return await Te.getVectorDBConnector().user(Ye.team(n)).delete(i,m.embeddingIds||[]),await rt.Instance.delete(c,Ye.team(n)),o+=`Deleted data source with id: ${l}\n`,{_debug:o,Success:!0}}catch(e){return o+=`Failed to delete data source: \n Error: ${e?.message}\n`,{_debug:o,_error:e?.message||"Couldn't delete data source"}}}generateContextUID(e,t,s){return`${t}::${s}::${e}`}validateInput(e){return c.object({}).unknown(!0).validate(e)}validateConfigData(e){return c.object({namespaceId:c.string().required(),id:c.string().optional().allow("").allow(null)}).unknown(!0).validate(e)}},JSONFilter:new class extends yt{constructor(){super(),ss(this,"configSchema",c.object({fields:c.string().max(3e4).allow("").label("Prompt")}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);n.debug("=== JSONFilter Log ===");let o={},r=null;try{t.id;const s=t.data.fields;o=function(e,t){const s=t?.split(",").map((e=>e.trim()));function n(e){return Array.isArray(e)?e.map(n):null!==e&&"object"==typeof e?Object.keys(e).filter((e=>s.includes(e))).reduce(((t,s)=>(t[s]=n(e[s]),t)),{}):e}return n(e)}(e.Input,s),n.debug("Output filtered")}catch(e){r=e,n.error(` JSONFilter Error \n ${e.toString()}`)}return{Output:o,_error:r,_debug:n.output}}},LogicAND:new class extends yt{constructor(){super()}init(){}async process(e,t,s){await super.process(e,t,s),this.createComponentLogger(s,t.name);const n={Output:!0};for(let s of t.inputs)if(!e[s.name]){n.Output=void 0;break}return n.Verified=void 0!==n.Output,n.Unverified=!n.Verified,n.Verified||delete n.Verified,n.Unverified||delete n.Unverified,n}},LogicOR:new class extends yt{constructor(){super()}init(){}async process(e,t,s){await super.process(e,t,s);const n={Output:void 0};console.log(e),console.log(t);for(let s of t.inputs)if(e[s.name]){n.Output=!0;break}return n.Verified=void 0!==n.Output,n.Unverified=!n.Verified,n.Verified||delete n.Verified,n.Unverified||delete n.Unverified,n}},LogicXOR:new class extends yt{constructor(){super()}init(){}async process(e,t,s){await super.process(e,t,s);const n={Output:void 0};let o=0;for(let s of t.inputs)e[s.name]&&o++;return 1===o&&(n.Output=!0),n.Verified=void 0!==n.Output,n.Unverified=!n.Verified,n.Verified||delete n.Verified,n.Unverified||delete n.Unverified,n}},LogicAtLeast:new class extends yt{constructor(){super(),os(this,"configSchema",c.object({minSetInputs:c.string().custom(rs({min:0,max:9}),"custom range validation").label("Minimum Inputs")}))}init(){}async process(e,t,s){await super.process(e,t,s),this.createComponentLogger(s,t.name);const n={Output:void 0};if("string"!=typeof t.data.minSetInputs||""===t.data.minSetInputs.trim()||isNaN(Number(t.data.minSetInputs)))return n;const o=Number(t.data.minSetInputs);if(t.inputs.length<o)return n;let r=0;for(let s of t.inputs)e[s.name]&&r++;return r>=o&&(n.Output=!0),n.Verified=void 0!==n.Output,n.Unverified=!n.Verified,n.Verified||delete n.Verified,n.Unverified||delete n.Unverified,n}},LogicAtMost:new class extends yt{constructor(){super(),is(this,"configSchema",c.object({maxSetInputs:c.string().custom(ls({min:0,max:9}),"custom range validation").label("Maximum Inputs")}))}init(){}async process(e,t,s){await super.process(e,t,s);const n={Output:void 0};if("string"!=typeof t.data.maxSetInputs||""===t.data.maxSetInputs.trim()||isNaN(Number(t.data.maxSetInputs)))return n;const o=Number(t.data.maxSetInputs);if(t.inputs.length<o)return n;let r=0;for(let s of t.inputs)if(e[s.name]&&(r++,r>o))break;return r<=o&&(n.Output=!0),n.Verified=void 0!==n.Output,n.Unverified=!n.Verified,n.Verified||delete n.Verified,n.Unverified||delete n.Unverified,n}},AgentPlugin:new class extends yt{constructor(){super(),Ls(this,"configSchema",c.object({agentId:c.string().max(200).required(),openAiModel:c.string().max(200).required(),descForModel:c.string().max(5e3).allow("").label("Description for Model"),id:c.string().max(200),name:c.string().max(500),desc:c.string().max(5e3).allow("").label("Description"),logoUrl:c.string().max(8192).allow(""),version:c.string().max(100).allow(""),domain:c.string().max(253).allow("")}))}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);n.debug("=== Agent Plugin Log ===");try{const o=t.data?.agentId;if(!o)return{_error:"Agent Component ID is required!",_debug:n.output};const r=s.agentRuntime?.reqTag,a=(vt(t?.data?.descForModel).parse(e).result,"string"==typeof e?.Prompt?e?.Prompt:JSON.stringify(e?.Prompt)),i=Te.getAgentDataConnector(),l=await i.isDeployed(o);let c=t.data?.version||"";if(n.debug("Version: ",c),"same-as-parent"===c)if(await i.isDeployed(s?.id)){if(!l)return{_error:`Call failed, Agent '${t.data?.name}' (${o}) is not deployed. Please deploy the agent and try again.`,_debug:n.output};c="latest"}else c="";else if("dev-latest"===c)c="";else if("prod-latest"===c){if(!l)return{_error:`Call failed, Agent '${t.data?.name}' (${o}) is not deployed. Please deploy the agent and try again.`,_debug:n.output};c="latest"}const u=await new vs(t?.data?.openAiModel,o).prompt(a,{"X-AGENT-ID":o,"X-AGENT-VERSION":c,"X-REQUEST-TAG":r,"x-caller-session-id":s.callerSessionId});return n.debug("Response:\n",u,"\n"),{Response:u,_debug:n.output}}catch(e){return console.error("Error on running Agent Component: ",e),{_error:`Error on running Agent Component!\n${e?.message||JSON.stringify(e)}`,_debug:n.output}}}},LLMAssistant:new class extends yt{constructor(){super(),Os(this,"configSchema",c.object({model:c.string().max(200).required(),behavior:c.string().max(3e4).allow("").label("Behavior")}))}init(){}async process(e,t,s){await super.process(e,t,s);const n=this.createComponentLogger(s,t.name);try{n.debug("== LLM Assistant Log ==\n");const o=t.data.model||"echo",r=t.data.ttl||void 0,a=$t.load(o);if(!a.connector)return{_error:`The model '${o}' is not available. Please try a different one.`,_debug:n.output};n.debug(` Model : ${o}`);const i=e.UserInput,l=e.UserId,c=e.ConversationId;let u=vt(t.data.behavior).parse(e).result;n.debug(`[Parsed Behavior] \n${u}\n\n`);const m=a.modelInfo?.tokens??2048,p=await async function(e,t,s,n=ys){if(!t&&!s)return[];const o=Rs(),r=`${e}:conv-u${t}-c${s}`,a=await o.user(Ye.agent(e)).get(r),i=a?pt(a).tryParse():[],l=[];let c=0;"system"==i[0]?.role&&(c+=k(i[0]?.content).length+3);for(let e=i.length-1;e>=0;e--){if("system"==i[e].role)continue;const t=i[e],s=k(t?.content).length+3;if(c+s>n)break;l.unshift(t),c+=s}return"system"==i[0]?.role&&l.unshift(i[0]),l}(s.id,l,c,Math.round(m/2));"system"!=p[0]?.role&&p.unshift({role:"system",content:u}),p.push({role:"user",content:i});const d={messages:p},h=await a.promptRequest(null,t,s,d).catch((e=>({error:e})));if(!h)return{_error:" LLM Error = Empty Response!",_debug:n.output};if(h?.error)return n.error(` LLM Error=${JSON.stringify(h.error)}`),{Response:h?.data,_error:h?.error+" "+h?.details,_debug:n.output};p.push({role:"assistant",content:h}),async function(e,t,s,n,o){if(!t&&!s)return;const r=`${e}:conv-u${t}-c${s}`;Rs().user(Ye.agent(e)).set(r,JSON.stringify(n),null,null,o)}(s.id,l,c,p,r);const g={Response:h};return g._debug=n.output,g}catch(e){return{_error:e.message,_debug:n.output}}}}};var Es=Object.defineProperty;ye("AgentLogger");const Ms=class e{constructor(e){this.agent=e}static async cleanup(){const t=Object.keys(e.transactions);for(const s of t)e.transactions[s].canDelete()&&delete e.transactions[s]}static log(e,t,s){return t||(t="log-"+F()),t}static async logTask(e,t){}};((e,t,s)=>{((e,t,s)=>{t in e?Es(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s})(e,"symbol"!=typeof t?t+"":t,s)})(Ms,"transactions",{});let Ds=Ms;var qs=Object.defineProperty,$s=(e,t,s)=>((e,t,s)=>t in e?qs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const Ns=ye("RuntimeContext");class js extends i{constructor(e){super(),this.runtime=e,$s(this,"circularLimitReached",!1),$s(this,"step",0),$s(this,"sessionResult",!1),$s(this,"sessionResults"),$s(this,"components",{}),$s(this,"checkRuntimeContext",null),$s(this,"ctxFile",""),$s(this,"_runtimeFileReady");const t=e.agent,s=w.join(ie.env.DATA_PATH,`/debug/${t.id}/`);b.existsSync(s)||b.mkdirSync(s,{recursive:!0});const n=(e.processID?.split(":")[0]||"")==e.xDebugId?"":"."+F()+e.reqTag;this.ctxFile=w.join(s,`${e.xDebugId}${n}${t.jobID?`-job-${t.jobID}`:""}.json`),this.initRuntimeContext()}serialize(){return{step:this.step,sessionResult:this.sessionResult,sessionResults:this.sessionResults,components:this.components}}deserialize(e){this.step=e.step,this.sessionResult=e.sessionResult,this.sessionResults=e.sessionResults,this.components=e.components}reset(){this.step=0,this.sessionResult=!1,this.sessionResults=null,this.components={}}initRuntimeContext(){if(this._runtimeFileReady)return;const e=this.runtime.xDebugId?.startsWith("dbg-");Ns.debug("Init ctxFile",this.ctxFile);const t=this.runtime.agent;let s=(t.agentRequest.method||"POST").toUpperCase();const n=t.endpoints?.[t.agentRequest.path]?.[s];let o={};if(b.existsSync(this.ctxFile))o=JSON.parse(b.readFileSync(this.ctxFile,"utf8")),o.step||(o.step=0);else{o=JSON.parse(JSON.stringify({components:t.components,connections:t.connections,timestamp:Date.now()})),o.step||(o.step=0);for(let t in o.components){o.components[t]={id:t,name:o.components[t].name,ctx:{active:!1,name:o.components[t].name}};const s=o.components[t];n&&null!=n.id&&s.id==n.id&&e&&(s.ctx.active=!0)}b.writeFileSync(this.ctxFile,JSON.stringify(o,null,2))}this.deserialize(o),this._runtimeFileReady=!0,this.emit("ready")}async sync(){if(this.ctxFile)if(this.emit("syncing"),this.runtime.sessionClosed)this.runtime.debug&&b.existsSync(this.ctxFile)&&await J(6e4),b.existsSync(this.ctxFile)&&b.unlinkSync(this.ctxFile);else{const e=this.serialize();e&&b.writeFileSync(this.ctxFile,JSON.stringify(e,null,2))}}incStep(){this.step++,this.sync()}updateComponent(e,t){const s=this;if(!s)return;const n=s.components[e];n||(Ns.log(">>>>>>> updateComponent Component debug data not found",e,n),Ns.log(">>> ctxFile",this.ctxFile),Ns.log(">>> ctxData",s)),n.ctx={...n.ctx,...t,step:this.step},this.sync()}resetComponent(e){const t=this.components[e];t||(Ns.log(">>>>>>> resetComponent Component debug data not found",e,t),Ns.log(">>> ctxFile",this.ctxFile),Ns.log(">>> ctxData",this)),t.ctx.runtimeData={},t.ctx.active=!1,this.sync()}getComponentData(e){const t=this;if(!t)return null;const s=t.components[e];return s||(Ns.log(">>>>>>> getComponentData Component debug data not found",e,s),Ns.log(">>> ctxFile",this.ctxFile),Ns.log(">>> ctxData",t)),s.ctx}}var Gs=Object.defineProperty,Bs=(e,t,s)=>((e,t,s)=>t in e?Gs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const Vs=ye("AgentRuntime"),Us=new Proxy({},{get:function(e,t,s){return"function"==typeof e[t]?e[t]:function(){Vs.warn(`AgentRuntime Unavailable tried to call : ${t.toString()}`)}}}),Fs=class e{constructor(t){this.agent=t,Bs(this,"agentContext"),Bs(this,"xDebugRun",""),Bs(this,"xDebugInject",""),Bs(this,"xDebugRead",""),Bs(this,"xDebugStop",""),Bs(this,"xDebugPendingInject",null),Bs(this,"xDebugId",""),Bs(this,"xDebugCmd",""),Bs(this,"_debugActive",!1),Bs(this,"_runtimeFileReady",!1),Bs(this,"sessionClosed",!1),Bs(this,"reqTagOwner",!1),Bs(this,"reqTag"),Bs(this,"processID"),Bs(this,"workflowReqId"),Bs(this,"alwaysActiveComponents",{}),Bs(this,"exclusiveComponents",{}),Bs(this,"checkRuntimeContext",null),this.reqTag=t.agentRequest.header("X-REQUEST-TAG");const s=!!this.reqTag;this.reqTag?(this.xDebugStop=void 0,this.xDebugRun=void 0,this.xDebugInject=void 0,this.xDebugRead=void 0):(this.xDebugStop=t.agentRequest.header("X-DEBUG-STOP"),this.xDebugRun=t.agentRequest.header("X-DEBUG-RUN"),this.xDebugInject=t.agentRequest.header("X-DEBUG-INJ"),this.xDebugRead=t.agentRequest.header("X-DEBUG-READ"),this.reqTag="xTAG-"+F(),this.reqTagOwner=!0),this.xDebugId=this.xDebugStop||this.xDebugRun||this.xDebugRead,!this.xDebugId&&t.agentRequest.body&&(null!=this.xDebugInject&&null!=this.xDebugInject?(this.xDebugPendingInject=t.agentRequest.body,this.xDebugRun=this.xDebugInject||"inj-"+F()):""==this.xDebugRun&&(this.xDebugRun="dbg-"+F()),this.xDebugId=this.xDebugRun),this.processID=this.xDebugId,this.xDebugId||(this.xDebugId=t.sessionId,this.processID=this.reqTag),s&&(this.processID+=`:${Math.floor(1e3+9e3*Math.random())}`),this.workflowReqId=this.xDebugRun||this.xDebugStop||this.reqTag,e.tagsData[this.reqTag]||(e.tagsData[this.reqTag]={}),e.processResults[this.processID]||(e.processResults[this.processID]={timestamp:Date.now(),errorResults:[],sessionResults:[]}),this.agentContext=new js(this),this.agentContext.on("ready",(()=>{this.alwaysActiveComponents={},this.exclusiveComponents={};for(let e of this.agent.data.components){const t=Ss[e.name];if(t){if(t.alwaysActive){this.alwaysActiveComponents[e.id]=t,this.updateComponent(e.id,{active:!0,alwaysActive:!0});const s={...this.getRuntimeData(e.id)};this.saveRuntimeComponentData(e.id,s)}if(t.exclusive){this.exclusiveComponents[e.id]=t,this.updateComponent(e.id,{exclusive:!0});const s={...this.getRuntimeData(e.id)};this.saveRuntimeComponentData(e.id,s)}}else Vs.warn(`Component ${e.name} Exists in agent but has no implementation`)}})),this._debugActive=this.xDebugId!=t.sessionId}get circularLimitReached(){return this.agentContext?.circularLimitReached||!1}set circularLimitReached(e){this.agentContext&&(this.agentContext.circularLimitReached=e)}get debug(){return this._debugActive}get curStep(){return this.agentContext?.step||0}destroy(){this.sessionClosed=!0,this.sync()}incTag(t){e.tagsData[this.reqTag][t]||(e.tagsData[this.reqTag][t]=0),e.tagsData[this.reqTag][t]++}async sync(){(this.reqTagOwner&&this.sessionClosed||this.circularLimitReached)&&(Vs.log(">>>>>>>>>>>> deleting tagsData",this.reqTag),delete e.tagsData[this.reqTag]),this.agentContext.sync()}getWaitingComponents(){const e=this.agentContext;return Object.values(e?.components||[]).filter((e=>1==e?.ctx?.active)).filter((e=>e?.ctx?.status&&void 0!==typeof e?.ctx?.output))}getExclusiveActiveComponents(){const e=this.agentContext;return Object.values(e?.components||[]).filter((e=>1==e?.ctx?.active)).filter((e=>1==e?.ctx?.exclusive))}readState(e,t=!1){if(!this._debugActive||!e)return null;const s=this,n=this.agent,o=s.agentContext,r=s.xDebugPendingInject||Object.values(o?.components||[]);let a;a=r.filter((e=>1==e?.ctx?.active&&1==e?.ctx?.exclusive)),(!a||0==a.length)&&(a=r.filter((e=>1==e?.ctx?.active||!e?.ctx?.output?._error&&Array.isArray(e?.ctx?._job_components)&&e?.ctx?._job_components.length>0))),r.filter((e=>1==e?.ctx?.active&&e?.ctx?.status&&void 0!==typeof e?.ctx?.output)),r.filter((e=>1==e?.ctx?.active&&!e?.ctx?.status));let i={};for(let e of r)i[e.id]=e.ctx;let l=e;(!a||0==a.length)&&(l=null,s.sessionClosed=!0);const c=Object.values(o?.components||[]).filter((e=>1==e?.ctx?.active&&!e?.ctx?.alwaysActive)),u=Object.values(o?.components||[]).filter((e=>!e?.ctx?.output?._error&&Array.isArray(e?.ctx?._job_components)&&e?.ctx?._job_components.length>0));if(0==c.length&&0==u.length&&(s.sessionClosed=!0),s.circularLimitReached){const e=`Circular Calls Limit Reached on ${s.checkCircularLimit()}. Current agent circular limit is ${n.circularLimit}`;return s.sessionClosed=!0,{state:i,dbgSession:l,sessionClosed:s.sessionClosed,error:e}}const m=this.curStep>=1?this.curStep-1:0;if(t){const e={};for(let t in i){const s=i[t];s.step>=m&&(e[t]=s)}i=e}return{state:i,dbgSession:l,sessionClosed:s.sessionClosed,step:m}}async runCycle(){Vs.debug(`runCycle agentId=${this.agent.id} wfReqId=${this.workflowReqId}  reqTag=${this.reqTag} session=${this.xDebugRun} cycleId=${this.processID}`);const t=this,s=this.agent,n=t.agentContext,o=t.xDebugPendingInject||Object.values(n?.components||[]);let r;r=o.filter((e=>1==e?.ctx?.active&&1==e?.ctx?.exclusive)),(!r||0==r.length)&&(r=o.filter((e=>1==e?.ctx?.active||!e?.ctx?.output?._error&&Array.isArray(e?.ctx?._job_components)&&e?.ctx?._job_components.length>0)));const a=o.filter((e=>1==e?.ctx?.active&&e?.ctx?.status&&void 0!==typeof e?.ctx?.output)),i=o.filter((e=>1==e?.ctx?.active&&!e?.ctx?.status||!e?.ctx?.output?._error&&Array.isArray(e?.ctx?._job_components)&&e?.ctx?._job_components.length>0));let l;if((!r||0==r.length)&&(t.sessionClosed=!0,l={state:{sessionClosed:!0},dbgSession:null,expiredDbgSession:t.xDebugId,sessionClosed:!0}),!l&&r.length==a.length&&n.sessionResult&&(t.sessionClosed=!0,l={state:{sessionClosed:!0},dbgSession:null,expiredDbgSession:t.xDebugId,sessionClosed:!0}),!l&&i.length>0){const e=[];for(let n of i){const o=t.xDebugPendingInject?n.ctx.input:void 0;e.push(s.callComponent(n.ctx.sourceId,n.id,o))}const r=await Promise.all(e),a=1==r.length?r[0]:r;t.xDebugPendingInject=null;const c=Object.values(n?.components||[]).filter((e=>1==e?.ctx?.active)),u=Object.values(n?.components||[]).filter((e=>!e?.ctx?.output?._error&&Array.isArray(e?.ctx?._job_components)&&e?.ctx?._job_components.length>0));o.filter((e=>e?.ctx?.status&&void 0!==typeof e?.ctx?.output)).length==c.length&&(n.sessionResult=!0);let m=r.flat().filter((e=>e.id&&e.result&&!e.result._missing_inputs&&!s.connections.find((t=>t.sourceId==e.id)))),p=r.flat().filter((e=>e.id&&(e.error||e.result?._error)));n.sessionResult&&0==m.length&&t.sessionClosed&&(m=p),n.sessionResults=m,l={state:a,dbgSession:t.xDebugRun,sessionResult:t.agentContext.sessionResult,sessionResults:t.agentContext.sessionResults,errorResults:p,sessionClosed:0==c.length&&0==u.length}}else t.sessionClosed=!0,l={state:{sessionClosed:!0},dbgSession:null,expiredDbgSession:t.xDebugId,sessionClosed:!0};if(this.checkCircularLimit(),l.sessionResults&&e.processResults[this.processID].sessionResults.push(l.sessionResults),l.errorResults&&e.processResults[this.processID].errorResults.push(l.errorResults),l?.sessionClosed||this.circularLimitReached){const e=this.processResults();l.finalResult=e,t.sessionClosed=!0}return this.incStep(),this.sync(),l}processResults(){let t={error:"Error processing results"};const s=e.processResults[this.processID].sessionResults,n=e.processResults[this.processID].errorResults;if(this.circularLimitReached)t={error:`Circular Calls Limit Reached on ${this.circularLimitReached}. Current circular limit is ${this.agent.circularLimit}`};else{let e=[s,n].flat(1/0);(!e||0==e.length)&&(e=n.flat(1/0)),t=e.reduce(((e,t)=>(e.seen[t.id]||(e.result.push(t),e.seen[t.id]=!0),e)),{seen:{},result:[]}).result.filter((e=>!e.result?._exclude))}return delete e.processResults[this.processID],this.sync(),t}checkCircularLimit(){if(this.circularLimitReached)return this.agentContext.circularLimitReached;for(let t in e.tagsData[this.reqTag])if(e.tagsData[this.reqTag][t]>this.agent.circularLimit)return this.sessionClosed=!0,this.agentContext.circularLimitReached=t,t;return!1}async injectDebugOutput(e){if(this.xDebugPendingInject){const t=this.xDebugPendingInject.find((t=>t.id==e));if(t?.ctx?.output){let e=!0;for(let s in t.ctx.output)if(""!=t.ctx.output[s]){e=!1;break}return e?null:t.ctx.output}}}getRuntimeData(e){const t=this.getComponentData(e);return t&&t.runtimeData||{}}updateRuntimeData(e,t){const s=this.getComponentData(e);s&&(s.runtimeData={...s.runtimeData,...t},this.sync())}saveRuntimeComponentData(e,t){this.updateComponent(e,{runtimeData:t})}incStep(){this.agentContext.incStep()}updateComponent(e,t){this.agentContext.updateComponent(e,t)}resetComponent(e){this.agentContext.resetComponent(e)}getComponentData(e){return this.agentContext.getComponentData(e)}};Bs(Fs,"processResults",{}),Bs(Fs,"tagsData",{}),Bs(Fs,"dummy",Us);let Ks=Fs;!function(){const e=v.totalmem(),t=v.freemem(),s=e-t;(e/1024**3).toFixed(2),(t/1024**3).toFixed(2),(s/1024**3).toFixed(2),(s/e*100).toFixed(2)}();const Js=function(){const e=v.cpus();let t=0,s=0,n=0,o=0,r=0,a=0;for(let a of e)t+=a.times.user,s+=a.times.nice,n+=a.times.sys,o+=a.times.idle,r+=a.times.irq;return a=t+s+n+o+r,{user:t/a*100,sys:n/a*100,idle:o/a*100,load:100-o/a*100}}();var zs=Object.defineProperty,Ws=(e,t,s)=>((e,t,s)=>t in e?zs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const Hs=ye("Agent");class Qs{constructor(e,t,s,n){this.id=e,this.agentSettings=s,Ws(this,"name"),Ws(this,"data"),Ws(this,"teamId"),Ws(this,"components"),Ws(this,"connections"),Ws(this,"endpoints",{}),Ws(this,"sessionId"),Ws(this,"sessionTag",""),Ws(this,"callerSessionId"),Ws(this,"apiBasePath","/api"),Ws(this,"agentRuntime"),Ws(this,"usingTestDomain",!1),Ws(this,"domain",""),Ws(this,"debugSessionEnabled",!1),Ws(this,"circularLimit",100),Ws(this,"version",""),Ws(this,"agentVariables",{}),Ws(this,"_kill",!1),Ws(this,"async",!1),Ws(this,"jobID",""),Ws(this,"planInfo",{}),Ws(this,"agentRequest");const o="string"==typeof t?JSON.parse(t):t;this.name=o.name,this.data=o.data,this.version=this.data.agentVersion||"",this.teamId=o.teamId,this.connections=this.data.connections,this.debugSessionEnabled=this.data.debugSessionEnabled,this.agentVariables=o.data.variables||{};const r=this.data.components.filter((e=>"APIEndpoint"==e.name));for(let e of r){let t=e.data.method||"POST";t=t.toUpperCase(),this.endpoints[`${this.apiBasePath}/${e.data.endpoint}`]||(this.endpoints[`${this.apiBasePath}/${e.data.endpoint}`]={}),this.endpoints[`${this.apiBasePath}/${e.data.endpoint}`][t]=e}this.components={};for(let e of this.data.components)this.components[e.id]=e;for(let e of this.data.connections){const t=this.components[e.sourceId],s=this.components[e.targetId],n=e.sourceIndex,o=e.targetIndex;t.outputs[n].next||(t.outputs[n].next=[]),t.outputs[n].next.push(s.id),s.inputs[o].prev||(s.inputs[o].prev=[]),s.inputs[o].prev.push(t.id)}this.tagAsyncComponents(),n&&this.setRequest(n)}setRequest(e){if(this.agentRequest)return;this.agentRequest=e,this.agentRequest=e;const t=function(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}-${String(e.getHours()).padStart(2,"0")}-${String(e.getMinutes()).padStart(2,"0")}-${String(e.getSeconds()).padStart(2,"0")}`}();this.sessionId="rt-"+(this.agentRequest.sessionID||t+"."+F());const s=this?.agentRequest?.headers["x-session-tag"];s&&(this.sessionTag+=this.sessionTag?`,${s}`:s);var n=new RegExp(`^/v[0-9]+(.[0-9]+)?${this.apiBasePath}/(.*)`);this.agentRequest?.path?.startsWith(`${this.apiBasePath}/`)||this.agentRequest?.path?.match(n)?(this.agentRuntime=new Ks(this),this.callerSessionId=this?.agentRequest?.headers["x-caller-session-id"]?.substring(0,256)||this.agentRuntime.workflowReqId||this.sessionId):this.agentRuntime=Ks.dummy}kill(){this._kill=!0}async parseVariables(){if("object"==typeof this.agentVariables)for(let e in this.agentVariables){const t=this.agentVariables[e];t.startsWith("{{")&&t.endsWith("}}")&&(this.agentVariables[e]=await vt(t).parseTeamKeys(this.teamId).asyncResult)}}async process(e,t){let s;const n=Ds.log(this,null,{sourceId:e,componentId:"AGENT",domain:this.domain,input:t,workflowID:this.agentRuntime.workflowReqId,processID:this.agentRuntime.processID,inputTimestamp:(new Date).toISOString(),sessionID:this.callerSessionId,tags:this.sessionTag}),o=this.agentRequest.method.toUpperCase(),r=this.endpoints[e]?.[o];if(this.agentRuntime.debug){if(!r&&"/api/"!=this.agentRequest.path)throw n&&Ds.log(this,n,{error:`Endpoint ${o} ${e} Not Found`}),new Error(`Endpoint ${o} ${e} Not Found`);let t;if(t||(t=await this.agentRuntime.runCycle()),t&&typeof t?.state<"u")return this.agentRuntime.sync(),t?.finalResult&&(t.finalResult=await this.postProcess(t.finalResult).catch((e=>({error:e})))),t}if(!r)throw n&&Ds.log(this,n,{error:`Endpoint ${o} ${e} Not Found`}),new Error(`Endpoint ${o} ${e} Not Found`);let a;this.agentRuntime.updateComponent(r.id,{active:!0,input:t,sourceId:null});do{a=await this.agentRuntime.runCycle();const e=Math.floor(Js.load*this.planInfo?.maxLatency||0);await J(30+e)}while(!a?.finalResult&&!this._kill);if(this._kill)return Hs.warn(`Agent ${this.id} was killed`),{error:"Agent killed"};if(s=await this.postProcess(a?.finalResult).catch((e=>({error:e}))),this.agentRuntime.circularLimitReached){const e=this.agentRuntime.circularLimitReached;throw s={error:`Circular Calls Limit Reached on ${e}. Current circular limit is ${this.circularLimit}`},new Error(`Circular Calls Limit Reached on ${e}. Current circular limit is ${this.circularLimit}`)}return n&&Ds.log(this,n,{outputTimestamp:""+Date.now(),result:s}),this.updateTasksCount(),this.agentRuntime.debug?{state:s,dbgSession:null,sessionClosed:!1}:s}async updateTasksCount(){}async postProcess(e){Array.isArray(e)&&(e=e.flat(1/0)),Array.isArray(e)||(e=[e]);for(let t=0;t<e.length;t++){const s=e[t];if(!s)continue;s._debug&&delete s._debug,s._debug_time&&delete s._debug_time;const n=this.components[s.id];if(!n)continue;const o=Ss[n.name];if(!o)continue;const r=await o.postProcess(s,n,this).catch((e=>({error:e})));e[t]=r}return 1==e.length&&(e=e[0]),e}hasLoopAncestor(e){if(!e.prev)return!1;for(let t of e.prev){const e=this.components[t];if("ForEach"==e.name)return!0;for(let t of e.inputs)if(this.hasLoopAncestor(t))return!0}}clearChildLoopRuntimeComponentData(e){const t=this.components[e],s=this.agentRuntime.getRuntimeData(e);if(s._ChildLoopData)for(let e of t.inputs)this.hasLoopAncestor(e)&&delete s.input[e.name]}getComponentMissingInputs(e,t){let s=[];const n=this.components[e];if(Ss[n.name].alwaysActive)return s;const o=this.findReadablePredecessors(e),r={};for(let e of o)e&&(r[e.input.name]=e);const a=this.connections.filter((t=>t.targetId==e)).map((e=>e.targetIndex)),i=n.inputs.filter((e=>a.includes(e.index)));if(Array.isArray(i)&&i.length>0)for(let e of i)if(!e.optional){if(r[e.name]){const t=r[e.name],s=t.component,n=this.components[t.id];if(s.hasOutput(t.output.name,n,this))continue}typeof t[e.name]>"u"&&s.push(e.name)}return s}findReadablePredecessors(e){const t=this.components[e];return t.name,this.connections.filter((t=>t.targetId==e)).map((e=>{const s=this.components[e.sourceId],n=Ss[s.name],o=s.outputs[e.sourceIndex],r=t.inputs[e.targetIndex];return n.hasReadOutput?{output:o,input:r,component:n,id:e.sourceId}:null})).filter((e=>null!=e))}updateStep(e,t){const s=this.agentRuntime,n=s.curStep;s.getComponentData(t),s.updateComponent(t,{step:n})}async callComponent(e,t,s){const n=this.agentRuntime,o=this.components[t],r=Ss[o.name];if(this._kill)return Hs.warn(`Agent ${this.id} was killed, skipping component ${o.name}`),{id:o.id,name:o.displayName,result:null,error:"Agent killed"};if(!r)throw new Error(`Component ${o.name} not found`);if(this.agentRuntime.incTag(t),this.agentRuntime.checkCircularLimit(),this.agentRuntime.circularLimitReached)return{error:"Circular Calls Reached"};n.getComponentData(t)?.output?._missing_inputs&&n.updateComponent(t,{output:{}});const a=this.prepareComponentInput(t,s),i=Ds.log(this,null,{sourceId:e||"AGENT",componentId:t,domain:this.domain,workflowID:this.agentRuntime.workflowReqId,processID:this.agentRuntime.processID,input:"APIEndpoint"==o.name?"GET"==this.agentRequest.method?this.agentRequest.query:this.agentRequest.body:a,inputTimestamp:(new Date).toISOString(),sessionID:this.callerSessionId,tags:this.sessionTag});let l=null,c=[];if(this.updateStep(e,t),n.debug&&(l=await n.injectDebugOutput(t)),!l){if(c=this.getComponentMissingInputs(t,a),c.length>0){n.updateComponent(t,{active:!0,status:"waiting"});const e=this.connections.filter((e=>e.sourceId==t))||[];for(let t of e)if("_error"==o.outputs[t.sourceIndex].name)break;l={_error:"Missing inputs : "+JSON.stringify(c),_missing_inputs:c}}if(!l){const e=await r.validateConfig(o);if(e._error)l=e;else try{await this.parseVariables(),l=await r.process({...this.agentVariables,...a},o,this),Hs.log(l)}catch(e){Hs.error("Error on component process: ",{componentId:t,name:o.name,input:a},e),l=e?.message?{Response:void 0,_error:e.message,_debug:e.message}:{Response:void 0,_error:e.toString(),_debug:e.toString()}}}}const u=this.agentRuntime.getRuntimeData(t);if(n.updateComponent(t,{output:l}),l._in_progress&&n.updateComponent(t,{active:!0,status:"in_progress"}),(l.error||l._error)&&(this.agentRuntime.resetComponent(t),i&&Ds.log(this,i,{error:l.error||l._error}),l.error))return[{id:o.id,name:o.displayName,result:null,error:l.error||l._error,_debug:l.error||l._error}];let m=[];if(l&&!l._missing_inputs){if(Ds.logTask(this,1),m=await this.callNextComponents(t,l).catch((e=>({error:e,id:o.id,name:o.displayName}))),u._LoopData&&l._in_progress&&null==u._LoopData.branches){const e=Array.isArray(m)?m.length:1;l._in_progress&&(u._LoopData.branches=e,n.updateRuntimeData(t,{_LoopData:u._LoopData}))}if(m._is_leaf){delete m._is_leaf;const e=u._ChildLoopData;if(e&&e.parentId){const t=e.parentId,s=this.agentRuntime.getRuntimeData(t)._LoopData;if(s){s.result||(s.result=[]);let e=JSON.parse(JSON.stringify(m));m.result&&(m.result._exclude=!0),e=await r.postProcess(e,o,this),s.result.push(e),s.branches--,s.branches<=0&&n.updateComponent(t,{active:!0,status:""}),n.updateRuntimeData(t,{_LoopData:s})}}else{const e=this.agentRuntime.getRuntimeData(t)._LoopData;e&&1==e.loopIndex&&(e._in_progress=!1,l._in_progress=!1,n.updateComponent(t,{active:!0,status:""}),n.updateRuntimeData(t,{_LoopData:e}))}}}return!l._missing_inputs&&!l._in_progress&&(u?._ChildLoopData?._in_progress&&u._ChildLoopData?.loopIndex<u._ChildLoopData?.loopLength?(this.clearChildLoopRuntimeComponentData(t),n.updateComponent(t,{active:!0,status:"waiting"})):this.agentRuntime.resetComponent(t)),Array.isArray(m)&&(m=m.flat(1/0).filter((e=>null!=e.result))),i&&Ds.log(this,i,{output:l,outputTimestamp:""+Date.now()}),[m,{id:o.id,name:o.displayName,result:l}]}JSONExpression(e,t){const s=t.split(/\.|\[|\]\.|\]\[|\]/).filter(Boolean);let n=e;for(let e of s){if(null==n)return;n=n[e]}return n}async callNextComponents(e,t){const s=this.agentRuntime,n=this.components[e];n.name;let o=this.connections.filter((t=>t.sourceId==e)).map((e=>({...e,output:t,componentData:n})));const r=s.getWaitingComponents(),a=r.map((e=>e.id)),i=Object.keys(this.agentRuntime.alwaysActiveComponents),l=this.connections.filter((e=>i.includes(e.sourceId)&&a.includes(e.targetId))).map((e=>{const t={};r.find((t=>t.id==e.targetId));const s=this.components[e.sourceId],n=Ss[s.name],o=s.outputs[e.sourceIndex];return t[o.name]=n.readOutput(o.name,s,this),{...e,output:t,componentData:this.components[e.sourceId]}}));if(o=[...o,...l],!Array.isArray(o)||0==o.length)return{id:n.id,name:n.name,result:t,_is_leaf:!0};const c=o.reduce(((e,t)=>{let s=t.targetId;return e[s]||(e[s]=[]),e[s].push(t),e}),{}),u=[];for(let t in c){const n=this.components[t];if(!this.async&&n.async&&"Async"!==n.name)continue;n.name;const o=c[t];if(Array.isArray(o)&&o.length>0){const r={};for(let e of o){const t=e.output,s=e.componentData,o=s.outputs[e.sourceIndex],a=n.inputs[e.targetIndex],i=o.expression||o.name,l=i.split("."),c=s.outputs.find((e=>e.default));let u;if(o.default?u=t[o.name]:c&&(u=t[c.name]?.[o.name]),void 0===u&&l.length>=1){let e=this.JSONExpression(t,i);void 0!==e&&(u=e)}if(void 0!==u){let e=[...[r[a.name]].flat(),...[u].flat()].filter((e=>void 0!==e));r[a.name]=1===e.length?e[0]:e}}if(!r||"{}"==JSON.stringify(r))continue;const a=this.prepareComponentInput(t,r),i=this.components[t],l=this.getComponentMissingInputs(t,a).length>0?"waiting":void 0,c=this.agentRuntime.getRuntimeData(e);let m=c._LoopData;(!m||!m._in_progress)&&(m=c._ChildLoopData),s.updateComponent(t,{active:!0,input:r,sourceId:e,status:l}),s.updateRuntimeData(t,{_ChildLoopData:m,_LoopData:null}),u.push({id:t,name:i.name,inputs:r}),l&&Ds.log(this,null,{sourceId:e,componentId:t,step:this.agentRuntime.curStep+1,domain:this.domain,workflowID:this.agentRuntime.workflowReqId,processID:this.agentRuntime.processID,input:{__action:"status_update",__status:l,data:r},inputTimestamp:(new Date).toISOString(),sessionID:this.callerSessionId,tags:this.sessionTag})}}if(0==u.length)return{id:n.id,name:n.name,result:t,_is_leaf:!0};const m=await Promise.all(u);return 1==m.length?m[0]:m}prepareComponentInput(e,t){const s=this.agentRuntime.getRuntimeData(e),n=this.components[e],o=s?.input||{};let r={...o};if(t)for(let e in t){let s=t[e];r[e]=[o[e],s].flat(1/0).filter((e=>void 0!==e)),1==r[e].length&&(r[e]=r[e][0])}const a=this.findReadablePredecessors(e);for(let e of a)if(e){const t=this.components[e.id],s=e.component.readOutput(e.output.name,t,this);s&&e.input?.name&&(r||(r={}),r[e.input.name]=s)}this.agentRuntime.updateRuntimeData(e,{input:r});for(let e of n.inputs)e.defaultVal&&void 0===r[e.name]&&(r[e.name]=vt(e.defaultVal).parse(this.agentVariables).result);return r}getConnectionSource(e){return this.components[e.sourceId].inputs.find((t=>t.index===e.sourceIndex))}getConnectionTarget(e){return this.components[e.targetId].inputs.find((t=>t.index===e.targetIndex))}recursiveTagAsyncComponents(e){const t=this;for(let s of e.outputs){if("Async"==e.name&&"JobID"===s.name)continue;const n=t.connections.filter((t=>t.sourceId===e.id&&t.sourceIndex===s.index));if(n)for(let e of n){const s=t.components[e.targetId];s&&(s.async=!0,this.recursiveTagAsyncComponents(s))}}}tagAsyncComponents(){const e=Object.values(this.components).filter((e=>"Async"===e.name));if(e&&0!=e.length)for(let t of e)t.async=!0,this.recursiveTagAsyncComponents(t)}}var Ys=Object.defineProperty,Xs=(e,t,s)=>((e,t,s)=>t in e?Ys(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const Zs=ye("SRE"),en=Te,tn=class e{constructor(){Xs(this,"started",!1),Xs(this,"initialized",!1),this.started=!0}static get Instance(){return e.instance||(e.instance=new e),e.instance}init(t){if(this.initialized)throw new Error("SRE already initialized");this.initialized=!0;const s=this.autoConf(t);for(let e in s)for(let t of s[e])en.init(e,t.Connector,t.Settings,t.Default);return Ie.emit("SRE:Initialized"),e.Instance}autoConf(e){const t={};for(let s in e){t[s]=[],"object"==typeof e[s]&&(e[s]=[e[s]]);let n=!1;for(let o of e[s])o.Connector?(o.Default&&(n&&console.warn(`Entry ${s} has more than one default Connector ... only the first one will be used`),n=!0),t[s].push(o)):console.warn(`Missing Connector Name in ${s} entry ... it will be ignored`);!n&&t[s].length>0&&(t[s][0].Default=!0)}return t}ready(){return this.initialized}async _stop(){Zs.info("Shutting Down SmythRuntime ..."),en._stop(),e.instance=void 0,this.started=!1}};Xs(tn,"instance");let sn=tn;const nn=ye("SecureConnector");class on extends _e{async start(){nn.info(`Starting ${this.name} connector ...`)}async stop(){nn.info(`Stopping ${this.name} connector ...`)}async hasAccess(e){const t=await this.getResourceACL(e.resourceId,e.candidate);if(t.checkExactAccess(e))return!0;const s=We.clone(e).setLevel(Ne.Owner);if(t.checkExactAccess(s))return!0;const n=We.clone(e).setCandidate(Ye.public());if(t.checkExactAccess(n))return!0;const o=await Te.getAccountConnector().getCandidateTeam(e.candidate),r=We.clone(e).setCandidate(Ye.team(o));if(t.checkExactAccess(r))return!0;const a=We.clone(r).setLevel(Ne.Owner);return!!t.checkExactAccess(a)}async getAccessTicket(e,t){const s=We.clone(t).resource(e);return{request:t,access:await this.hasAccess(s)?Fe.Granted:Fe.Denied}}static AccessControl(e,t,s){const n=s.value;return s.value=async function(...e){const[t,s]=e;if((await this.getAccessTicket(s,t)).access!==Fe.Granted)throw new Ke("Access Denied");return n.apply(this,e)},s}}class rn extends on{}var an=Object.defineProperty,ln=Object.getOwnPropertyDescriptor,cn=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?ln(t,s):t,a=e.length-1;a>=0;a--)(o=e[a])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&an(t,s,r),r},un=(e,t,s)=>((e,t,s)=>t in e?an(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const mn=ye("S3Storage");class pn extends rn{constructor(e){if(super(),this.config=e,un(this,"name","S3Storage"),un(this,"client"),un(this,"bucket"),!sn.Instance)throw new Error("SRE not initialized");this.bucket=e.bucket;const t={};e.region&&(t.region=e.region),e.accessKeyId&&e.secretAccessKey&&(t.credentials={accessKeyId:e.accessKeyId,secretAccessKey:e.secretAccessKey}),this.client=new C(t)}user(e){return{write:async(t,s,n,o)=>await this.write(e.writeRequest,t,s,n,o),read:async t=>await this.read(e.readRequest,t),delete:async t=>{await this.delete(e.readRequest,t)},exists:async t=>await this.exists(e.readRequest,t),getMetadata:async t=>await this.getMetadata(e.readRequest,t),setMetadata:async(t,s)=>{await this.setMetadata(e.writeRequest,t,s)},getACL:async t=>await this.getACL(e.readRequest,t),setACL:async(t,s)=>await this.setACL(e.writeRequest,t,s)}}async read(e,t){const s=new L({Bucket:this.bucket,Key:t});try{const e=await this.client.send(s);return await Z(e.Body)}catch(e){if("NotFound"===e.name||"NoSuchKey"===e.name)return;throw mn.error("Error reading object from S3",e.name,e.message),e}}async getMetadata(e,t){try{return await this.getS3Metadata(t)}catch(e){throw mn.error("Error getting access rights in S3",e.name,e.message),e}}async setMetadata(e,t,s){try{let e=await this.getS3Metadata(t);e||(e={}),e={...e,...s},await this.setS3Metadata(t,e)}catch(e){throw mn.error("Error setting access rights in S3",e),e}}async write(e,t,s,n,o){const r=e.candidate;let a={...o,"x-amz-meta-acl":tt.from(n).addAccess(r.role,r.id,Ne.Owner).ACL};const i=new P({Bucket:this.bucket,Key:t,Body:s,Metadata:this.serializeS3Metadata(a),ContentType:a.ContentType});try{await this.client.send(i)}catch(e){throw mn.error("Error writing object to S3",e.name,e.message),e}}async delete(e,t){const s=new O({Bucket:this.bucket,Key:t});try{await this.client.send(s)}catch(e){throw mn.error("Error deleting object from S3",e.name,e.message),e}}async exists(e,t){const s=new T({Bucket:this.bucket,Key:t});try{return await this.client.send(s),!0}catch(e){if("NotFound"===e.name||"NoSuchKey"===e.name)return!1;throw mn.error("Error checking object existence in S3",e.name,e.message),e}}async getResourceACL(e,t){const s=await this.getS3Metadata(e);return void 0!==s?tt.from(s?.["x-amz-meta-acl"]):(new tt).addAccess(t.role,t.id,Ne.Owner)}async getACL(e,t){try{const e=await this.getS3Metadata(t);return tt.from(e?.["x-amz-meta-acl"])}catch(e){throw mn.error("Error getting access rights in S3",e.name,e.message),e}}async setACL(e,t,s){try{let n=await this.getS3Metadata(t);n||(n={}),n["x-amz-meta-acl"]=tt.from(s).addAccess(e.candidate.role,e.candidate.id,Ne.Owner).ACL,await this.setS3Metadata(t,n)}catch(e){throw mn.error("Error setting access rights in S3",e),e}}migrateMetadata(e){if(!e.agentid&&!e.teamid&&!e.userid)return e;{const t=["agentid","teamid","userid"],s=new tt;for(let n of t){if(!e[n])continue;const t="agentid"===n?je.Agent:"teamid"===n?je.Team:je.User;s.addAccess(t,e[n].toString(),[Ne.Owner,Ne.Read,Ne.Write]),delete e[n]}s.migrated=!0;const n={"x-amz-meta-acl":s.ACL};for(let t in e)n[t]=e[t];return n}}serializeS3Metadata(e){let t={};e["x-amz-meta-acl"]&&(e["x-amz-meta-acl"]&&(t["x-amz-meta-acl"]="string"==typeof e["x-amz-meta-acl"]?e["x-amz-meta-acl"]:tt.from(e["x-amz-meta-acl"]).serializedACL),delete e["x-amz-meta-acl"]);for(let s in e)"ContentType"!=s&&(t[s]="string"==typeof e[s]?e[s]:JSON.stringify(e[s]));return t}deserializeS3Metadata(e){let t={};for(let s in e)if("x-amz-meta-acl"!==s)try{t[s]=JSON.parse(e[s])}catch{t[s]=e[s]}else t[s]=tt.from(e[s]).ACL;return t=this.migrateMetadata(t),t}async getS3Metadata(e){try{const t=new T({Bucket:this.bucket,Key:e}),s=await this.client.send(t),n=s.Metadata;if(!n||0===Object.keys(n).length)return{};let o=this.deserializeS3Metadata(n);return o.ContentType||(o.ContentType=s.ContentType?s.ContentType:"application/octet-stream"),o}catch(e){if("NotFound"===e.name||"NoSuchKey"===e.name)return;throw mn.error("Error reading object metadata from S3",e.name,e.message),e}}async setS3Metadata(e,t){try{const s=new L({Bucket:this.bucket,Key:e}),n=await this.client.send(s),o=await Z(n.Body),r=this.serializeS3Metadata(t),a=new P({Bucket:this.bucket,Key:e,Body:o,Metadata:r});await this.client.send(a)}catch(e){throw mn.error("Error setting object metadata in S3",e.name,e.message),e}}}cn([on.AccessControl],pn.prototype,"read",1),cn([on.AccessControl],pn.prototype,"getMetadata",1),cn([on.AccessControl],pn.prototype,"setMetadata",1),cn([on.AccessControl],pn.prototype,"write",1),cn([on.AccessControl],pn.prototype,"delete",1),cn([on.AccessControl],pn.prototype,"exists",1),cn([on.AccessControl],pn.prototype,"getACL",1),cn([on.AccessControl],pn.prototype,"setACL",1);class dn extends Re{register(){Te.register(U.Storage,"S3",pn)}}var hn={Echo:{maxTokens:"max_tokens",temperature:"temperature",stopSequences:"stop",topP:"top_p",frequencyPenalty:"frequency_penalty",presencePenalty:"presence_penalty"},OpenAI:{maxTokens:"max_tokens",temperature:"temperature",stopSequences:"stop",topP:"top_p",frequencyPenalty:"frequency_penalty",presencePenalty:"presence_penalty"},cohere:{maxTokens:"max_tokens",temperature:"temperature",stopSequences:"stop_sequences",topP:"p",topK:"k",frequencyPenalty:"frequency_penalty",presencePenalty:"presence_penalty"},togetherAI:{maxTokens:"max_tokens",temperature:"temperature",stopSequences:"stop",topP:"top_p",topK:"top_k",frequencyPenalty:"repetition_penalty"},AnthropicAI:{maxTokens:"max_tokens",temperature:"temperature",stopSequences:"stop_sequences",topP:"top_p",topK:"top_k"},GoogleAI:{maxTokens:"maxOutputTokens",temperature:"temperature",stopSequences:"stopSequences",topP:"topP",topK:"topK"},Groq:{maxTokens:"max_tokens",temperature:"temperature",stopSequences:"stop",topP:"top_p"}};const gn=ye("LLMConnector");class fn extends _e{user(e){if("agent"!==e.role)throw new Error("Only agents can use LLM connector");const t=Te.getVaultConnector();if(!t)throw new Error("Vault Connector unavailable, cannot proceed");return{chatRequest:async(s,n)=>{const o=Mt[n.model]?.llm;if(!o)throw new Error(`Model ${n.model} not supported`);return n.apiKey=await t.user(e).get(o).catch((e=>"")),this.chatRequest(e.readRequest,s,n)},visionRequest:async(s,n)=>{const o=Mt[n.model]?.llm;if(!o)throw new Error(`Model ${n.model} not supported`);return n.apiKey=await t.user(e).get(o).catch((e=>"")),this.visionRequest(e.readRequest,s,n,e.id)},toolRequest:async s=>{const n=Mt[s.model]?.llm;if(!n)throw new Error(`Model ${s.model} not supported`);return s.apiKey=await t.user(e).get(n).catch((e=>"")),this.toolRequest(e.readRequest,s)},streamToolRequest:async s=>{const n=Mt[s.model]?.llm;if(!n)throw new Error(`Model ${s.model} not supported`);return s.apiKey=await t.user(e).get(n).catch((e=>"")),this.streamToolRequest(e.readRequest,s)},streamRequest:async s=>{const n=Mt[s.model]?.llm;if(!n)throw new Error(`Model ${s.model} not supported`);return s.apiKey=await t.user(e).get(n).catch((e=>"")),this.streamRequest(e.readRequest,s)}}}getAllowedCompletionTokens(e,t=!1){const s=Mt[e]?.alias||e;return+((t?Mt[s]?.keyOptions?.completionTokens||Mt[s]?.keyOptions?.tokens:Mt[s]?.completionTokens||Mt[s]?.tokens)??ys)}async getSafeMaxTokens(e,t,s){let n=this.getAllowedCompletionTokens(t,s);return+(e>n?n:e)}async countVisionPromptTokens(e){let t=0;const s=e?.filter((e=>"text"===e.type)),n=k(s?.[0]?.text).length,o=e?.filter((e=>"image_url"===e.type));let r=0;for(const e of o){const t=e?.image_url?.url,{width:s,height:n}=await bn(t);r+=yn(s,n)}return t=n+r,t}resolveModelName(e){return Mt[e]?.alias||e}getAllowedContextTokens(e,t=!1){const s=this.resolveModelName(e);return+((t?Mt[s]?.keyOptions?.tokens:Mt[s]?.tokens)??ys)}checkTokensLimit({model:e,promptTokens:t,completionTokens:s,hasTeamAPIKey:n=!1}){const o=this.getAllowedContextTokens(e,n),r=t+s;return r>o?{isExceeded:!0,error:n?`This models' maximum content length is ${o} tokens. (This is the sum of your prompt with all variables and the maximum output tokens you've set in Advanced Settings) However, you requested approx ${r} tokens (${t} in the prompt, ${s} in the output). Please reduce the length of either the input prompt or the Maximum output tokens.`:`Input exceeds max tokens limit of ${o}. Please add your API key to unlock full length.`}:{isExceeded:!1,error:""}}validateTokensLimit({model:e,promptTokens:t,completionTokens:s,hasTeamAPIKey:n=!1}){const o=this.getAllowedContextTokens(e,n),r=t+s;if(r>o)throw new Error(n?`This models' maximum content length is ${o} tokens. (This is the sum of your prompt with all variables and the maximum output tokens you've set in Advanced Settings) However, you requested approx ${r} tokens (${t} in the prompt, ${s} in the output). Please reduce the length of either the input prompt or the Maximum output tokens.`:`Input exceeds max tokens limit of ${o}. Please add your API key to unlock full length.`)}enhancePrompt(e,t){if(!e)return e;let s=e;const n={};for(let e of t.outputs)e.default||(n[e.name]=e?.description?`<${e?.description}>`:"");const o=["_debug","_error"],r=Object.keys(n).filter((e=>!o.includes(e)));if(r.length>0){const e={};r.forEach((t=>e[t]="<value>")),s+="\n##\nExpected output format = "+JSON.stringify(e)+"\nThe output JSON should only use the entries from the output format."}return s}async extractLLMComponentParams(e){const t={},s=e.data.model,n=JSON.parse(JSON.stringify(e.data||{})),o={};for(const[e,t]of Object.entries(n)){let n=t;if("stopSequences"===e&&(n=n?n?.split(","):null),"string"==typeof n&&!isNaN(Number(n))&&(n=+n),"maxTokens"===e){let e=Number(n);if(!e)throw new Error("Max output token not provided");e=await this.getSafeMaxTokens(e,s,!1),n=e}o[e]=n}const r=Mt[s]?.alias||s,a=Mt[r]?.llm;for(const[e,s]of Object.entries(hn[a]))if(void 0!==o?.[e]||null!==o?.[e]||""!==o?.[e]){const n=o[e];t[s]=n}return t}async extractVisionLLMParams(e){const t={},s=e.data.model,n=await this.getSafeMaxTokens(+e.data.maxTokens,s,!1)||300,o=Mt[s]?.alias||s,r=Mt[o]?.llm;return t[hn[r]?.maxTokens]=n,t}postProcess(e){try{return pt(e).tryParse()}catch{return{error:"Invalid JSON response",data:e,details:"The response from the model is not a valid JSON object. Please check the model output and try again."}}}formatToolsConfig({type:e="function",toolDefinitions:t,toolChoice:s="auto"}){throw new Error("This model does not support tools")}prepareInputMessageBlocks({messageBlock:e,toolsData:t}){throw new Error("This model does not support tools")}hasSystemMessage(e){return!!Array.isArray(e)&&e?.some((e=>"system"===e.role))}separateSystemMessages(e){return{systemMessage:e.find((e=>"system"===e.role&&e.content))||{},otherMessages:e.filter((e=>"system"!==e.role&&e.content))}}}function yn(e,t,s="auto"){if("low"===s)return 85;const n=Math.max(e,t),o=Math.min(e,t);let r=o;n>2048&&(r=2048/n*o),r=Math.floor(.75*r);let a=Math.ceil(r/512);return o!==r&&(a*=Math.ceil(r*(n/o)/512)),170*a+85}async function bn(e){try{let t;if(H(e)){const s=e.replace(/^data:image\/\w+;base64,/,"");t=Buffer.from(s,"base64")}else{if(!se(e))throw new Error("Please provide a valid image url!");{const s=await r.get(e,{responseType:"arraybuffer"});t=Buffer.from(s.data)}}const s=R(t);return{width:s?.width||0,height:s?.height||0}}catch(e){throw gn.error("Error getting image dimensions",e),new Error("Please provide a valid image url!")}}var wn=Object.defineProperty,An=(e,t,s)=>((e,t,s)=>t in e?wn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class kn extends fn{constructor(){super(...arguments),An(this,"name","LLM:Echo")}async chatRequest(e,t,s){return{content:t,finishReason:"stop"}}async visionRequest(e,t,s){return{content:t,finishReason:"stop"}}async toolRequest(e,t){throw new Error("Echo model does not support tool requests")}async streamToolRequest(e,t){throw new Error("Echo model does not support tool requests")}async streamRequest(e,t){throw new Error("Echo model does not support streaming")}enhancePrompt(e,t){return e}postProcess(e){try{return pt(e).tryParse()}catch{return e}}}var xn=Object.defineProperty,_n=(e,t,s)=>((e,t,s)=>t in e?xn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const In=ye("OpenAIConnector");class vn extends fn{constructor(){super(...arguments),_n(this,"name","LLM:OpenAI")}async chatRequest(e,t,s){s.messages||(s.messages=[]),"system"!==s.messages[0]?.role&&(s.messages.unshift({role:"system",content:"All responses should be in valid json format. The returned json should not be formatted with any newlines or indentations."}),(s.model.startsWith("gpt-4-turbo")||s.model.startsWith("gpt-3.5-turbo"))&&(s.response_format={type:"json_object"})),t&&1===s.messages.length&&s.messages.push({role:"user",content:t}),delete s.prompt;const n=s?.apiKey;delete s.apiKey;const o=new S({apiKey:n||process.env.OPENAI_API_KEY}),r=A(s.messages,"gpt-4")?.length,a=this.checkTokensLimit({model:s.model,promptTokens:r,completionTokens:s?.max_tokens,hasTeamAPIKey:!!n});if(a.isExceeded)throw new Error(a.error);const i=await o.chat.completions.create(s);return{content:i?.choices?.[0]?.message.content,finishReason:i?.choices?.[0]?.finish_reason}}async visionRequest(e,t,s,n){(!s.messages||0===s.messages?.length)&&(s.messages=[]),"system"!==s.messages?.role&&s.messages.unshift({role:"system",content:'All responses should be in valid json format. The returned json should not be formatted with any newlines, indentations. For example: {"<guess key from response>":"<response>"}'});const o=s?.sources||[];delete s?.sources;const r=n instanceof Qs?n.id:n,a=[];for(let e of o){const t=(await e.readData(Ye.agent(r))).toString("base64"),s=`data:${e.mimetype};base64,${t}`;a.push({type:"image_url",image_url:{url:s}})}const i=[{type:"text",text:t},...a];s.messages.push({role:"user",content:i});try{const e=s?.apiKey;delete s.apiKey;const t=new S({apiKey:e||process.env.OPENAI_API_KEY}),n=await this.countVisionPromptTokens(i),o=this.checkTokensLimit({model:s.model,promptTokens:n,completionTokens:s?.max_tokens,hasTeamAPIKey:!!e});if(o.isExceeded)throw new Error(o.error);const r=await t.chat.completions.create({...s});return{content:r?.choices?.[0]?.message.content,finishReason:r?.choices?.[0]?.finish_reason}}catch(e){throw In.log("Error in visionLLMRequest: ",e),e}}async toolRequest(e,{model:t=bs,messages:s,max_tokens:n,toolsConfig:{tools:o,tool_choice:r},apiKey:a=""}){try{const e=new S({apiKey:a||process.env.OPENAI_API_KEY});if(!Array.isArray(s)||!s?.length)return{error:new Error("Invalid messages argument for chat completion.")};let i={model:t,messages:s,max_tokens:n};o&&o.length>0&&(i.tools=o),r&&(i.tool_choice=r);const l=await e.chat.completions.create(i),c=l?.choices?.[0]?.message,u=l?.choices?.[0]?.finish_reason;let m=[],p=!1;return"tool_calls"===u&&(m=c?.tool_calls?.map(((e,t)=>({index:t,id:e?.id,type:e?.type,name:e?.function?.name,arguments:e?.function?.arguments,role:"tool"})))||[],p=!0),{data:{useTool:p,message:c,content:c?.content??"",toolsData:m}}}catch(e){return In.log("Error on toolUseLLMRequest: ",e),{error:e}}}async streamToolRequest(e,{model:t=bs,messages:s,toolsConfig:{tools:n,tool_choice:o},apiKey:r=""}){try{const e=new S({apiKey:r||process.env.OPENAI_API_KEY});if(!Array.isArray(s)||!s?.length)return{error:new Error("Invalid messages argument for chat completion.")};In.log("model",t),In.log("messages",s);let a={model:t,messages:s,stream:!0};n&&n.length>0&&(a.tools=n),o&&(a.tool_choice=o);const i=await e.chat.completions.create(a),[l,c]=i.tee();let u,m=!1,p={},d=[],h={role:"",content:"",tool_calls:[]};for await(const e of l){if(p=e.choices[0].delta,h.role+=p?.role||"",h.content+=p?.content||"",!p?.tool_calls&&""===p?.content){u=c;break}if(p?.tool_calls){const e=p?.tool_calls?.[0],t=e?.index;d[t]={index:t,role:"tool",id:(d?.[t]?.id||"")+(e?.id||""),type:(d?.[t]?.type||"")+(e?.type||""),name:(d?.[t]?.name||"")+(e?.function?.name||""),arguments:(d?.[t]?.arguments||"")+(e?.function?.arguments||"")}}}return d?.length>0&&(m=!0),h.tool_calls=d.map((e=>({id:e.id,type:e.type,function:{name:e.name,arguments:e.arguments}}))),{data:{useTool:m,message:h,stream:u,toolsData:d}}}catch(e){return In.log("Error on toolUseLLMRequest: ",e),{error:e}}}async streamRequest(e,{model:t=bs,messages:s,max_tokens:n,toolsConfig:{tools:o,tool_choice:r},apiKey:a=""}){const l=new i,c=new S({apiKey:a||process.env.OPENAI_API_KEY});In.log("model",t),In.log("messages",s);let u={model:t,messages:s,max_tokens:n,stream:!0};o&&o.length>0&&(u.tools=o),r&&(u.tool_choice=r);const m=await c.chat.completions.create(u);return(async()=>{let e={},t=[];for await(const s of m)if(e=s.choices[0].delta,l.emit("data",e),!e?.tool_calls&&e?.content&&l.emit("content",e?.content,e?.role),e?.tool_calls){const s=e?.tool_calls?.[0],n=s?.index;t[n]={index:n,role:"tool",id:(t?.[n]?.id||"")+(s?.id||""),type:(t?.[n]?.type||"")+(s?.type||""),name:(t?.[n]?.name||"")+(s?.function?.name||""),arguments:(t?.[n]?.arguments||"")+(s?.function?.arguments||"")}}t?.length>0&&l.emit("toolsData",t),setTimeout((()=>{l.emit("end",t)}),100)})(),l}async extractVisionLLMParams(e){return await super.extractVisionLLMParams(e)}formatToolsConfig({type:e="function",toolDefinitions:t,toolChoice:s="auto"}){let n=[];return"function"===e&&(n=t.map((e=>{const{name:t,description:s,properties:n,requiredFields:o}=e;return{type:"function",function:{name:t,description:s,parameters:{type:"object",properties:n,required:o}}}}))),n?.length>0?{tools:n,tool_choice:s||"auto"}:{}}prepareInputMessageBlocks({messageBlock:e,toolsData:t}){const s=[];if(e){const t={...e,content:"object"==typeof e.content?JSON.stringify(e.content):e.content};s.push(t)}const n=t.map((e=>({tool_call_id:e.id,role:e.role,name:e.name,content:"string"==typeof e.result?e.result:JSON.stringify(e.result)})));return[...s,...n]}}var Cn=Object.defineProperty,Ln=(e,t,s)=>((e,t,s)=>t in e?Cn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const Pn=ye("GoogleAIConnector"),On=["gemini-1.5-pro-latest","gemini-1.5-pro","gemini-1.5-pro-001","gemini-1.5-flash-latest","gemini-1.5-flash","gemini-1.5-flash-001"],Tn=On,Rn=["video/mp4","video/mpeg","video/mov","video/avi","video/x-flv","video/mpg","video/webm","video/wmv","video/3gpp","image/png","image/jpeg","image/jpg","image/webp","image/heic","image/heif","audio/wav","audio/mp3","audio/aiff","audio/aac","audio/ogg","audio/flac","text/plain","text/html","text/css","text/javascript","application/x-javascript","text/x-typescript","application/x-typescript","text/csv","text/markdown","text/x-python","application/x-python-code","application/json","text/xml","application/rtf","text/rtf"],Sn=["image/png","image/jpeg","image/jpg","image/webp","image/heic","image/heif"];class En extends fn{constructor(){super(...arguments),Ln(this,"name","LLM:GoogleAI"),Ln(this,"validMimeTypes",Rn),Ln(this,"validImageMimeTypes",Sn)}async chatRequest(e,t,s){try{const e=s?.model||"gemini-pro",n=s?.apiKey,o=new E(n||process.env.GOOGLEAI_API_KEY);let r,a=s?.messages||[],i={};if(this.hasSystemMessage(s?.messages)){const e=this.separateSystemMessages(a);i=e.systemMessage,a=e.otherMessages}if(On.includes(e)?r=i?.content||"":t=`${t}\n${i?.content||""}`,s?.messages&&(t=s.messages.map((e=>e?.content||"")).join("\n")),"json"===(s?.responseFormat||"json")&&(Tn.includes(e)?s.responseMimeType="application/json":t+=ws),!t)throw new Error("Prompt is required!");r&&({model:e,generationConfig:s}.systemInstruction=r);const l={stopSequences:s.stopSequences,maxOutputTokens:s.maxOutputTokens,temperature:s.temperature,topP:s.topP,topK:s.topK},c=o.getGenerativeModel({model:e,systemInstruction:r,generationConfig:l}),{totalTokens:u}=await c.countTokens(t);this.validateTokensLimit({model:e,promptTokens:u,completionTokens:s?.maxOutputTokens,hasTeamAPIKey:!!n});const m=await((await c.generateContent(t))?.response),p=m?.text();return{content:p,finishReason:m.candidates[0].finishReason}}catch(e){throw Pn.error("Error in googleAI componentLLMRequest",e),e}}async visionRequest(e,t,s,n){try{const e=s?.model||"gemini-pro-vision",o=s?.apiKey,r=s?.fileSources||[],a=n instanceof Qs?n.id:n,i=Ye.agent(a),l=(await this.processValidFiles(r,i)).map((e=>async()=>{try{return{url:(await this.uploadFile({file:e,apiKey:o})).url,mimetype:e.mimetype}}catch{return null}})),c=await K(l);if(0===c?.length)throw new Error(`Unsupported file(s). Please make sure your file is one of the following types: ${this.validImageMimeTypes.join(", ")}`);const u=c.map((e=>({fileData:{mimeType:e.mimetype,fileUri:e.url}}))),m=1===u.length?[...u,{text:t}]:[t,...u],p={stopSequences:s.stopSequences,maxOutputTokens:s.maxOutputTokens,temperature:s.temperature,topP:s.topP,topK:s.topK},d=new E(o||process.env.GOOGLEAI_API_KEY).getGenerativeModel({model:e,generationConfig:p});Tn.includes(e)?s.responseMimeType="application/json":t+=ws;const{totalTokens:h}=await d.countTokens(m);this.validateTokensLimit({model:e,promptTokens:h,completionTokens:s?.maxOutputTokens,hasTeamAPIKey:!!o});const g=await((await d.generateContent(m))?.response),f=g?.text();return{content:f,finishReason:g.candidates[0].finishReason}}catch(e){throw Pn.error("Error in googleAI visionLLMRequest",e),e}}async toolRequest(e,{model:t=bs,messages:s,toolsConfig:{tools:n,tool_choice:o},apiKey:r=""}){try{throw new Error("Tools are not yet implemented for Google AI.")}catch(e){throw e}}async streamToolRequest(e,{model:t=bs,messages:s,toolsConfig:{tools:n,tool_choice:o},apiKey:r=""}){try{throw new Error("Tools are not yet implemented for Google AI.")}catch(e){throw e}}async streamRequest(e,{model:t=bs,messages:s,toolsConfig:{tools:n,tool_choice:o},apiKey:r=""}){try{throw new Error("Tools are not yet implemented for Google AI.")}catch(e){throw e}}async extractVisionLLMParams(e){return await super.extractVisionLLMParams(e)}formatToolsConfig({type:e="function",toolDefinitions:t,toolChoice:s="auto"}){const n=[];return{tools:[{function_declarations:t.map((e=>{const{name:t,description:s,properties:o,requiredFields:r}=e;return n.push(t),{name:t,description:s,parameters:{type:"OBJECT",properties:o,required:r}}}))}],tool_config:{function_calling_config:{mode:s||"AUTO",allowed_function_names:n}}}}async processValidFiles(e,t){const s=e.map((e=>async()=>e?"object"==typeof e&&e.url&&e.mimetype?await this.processObjectFileSource(e):z(e)?await this.processStringFileSource(e,t):null:null));return await K(s)}processObjectFileSource(e){const{mimetype:t,url:s}=e;return this.validImageMimeTypes.includes(t)?{url:s,mimetype:t}:null}async processStringFileSource(e,t){if(se(e)){const t=await oe(e);return this.validImageMimeTypes.includes(t)?{url:e,mimetype:t}:null}if(H(e)||Q(e)){const{mimetype:s}=await Y(e);return this.validImageMimeTypes.includes(s)?{url:(await new lt(e).getJsonData(t)).url,mimetype:s}:null}return null}async uploadFile({file:e,apiKey:t}){try{if(!t||!e?.url||!e?.mimetype)throw new Error("Missing required parameters to save file for Google AI!");const s=v.tmpdir(),n=w.basename(new URL(e.url).pathname),o=w.join(s,n),a=await r.get(e.url,{responseType:"stream"}),i=b.createWriteStream(o);a.data.pipe(i),await new Promise(((e,t)=>{i.on("finish",e),i.on("error",t)}));const l=new M(t),c=await l.uploadFile(o,{mimeType:e.mimetype,displayName:n}),u=c.file.name;let m=await l.getFile(u);for(;m.state===D.PROCESSING;)process.stdout.write("."),await new Promise((e=>setTimeout(e,1e4))),m=await l.getFile(u);if(m.state===D.FAILED)throw new Error("File processing failed.");return b.unlink(o,(e=>{e&&Pn.error("Error deleting temp file: ",e)})),{url:c.file.uri||""}}catch(e){throw new Error(`Error uploading file for Google AI ${e.message}`)}}}var Mn=Object.defineProperty,Dn=(e,t,s)=>((e,t,s)=>t in e?Mn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const qn=ye("AnthropicAIConnector"),$n=["image/png","image/jpeg","image/jpg","image/webp","image/gif"],Nn="{",jn="claude-3-5-sonnet-20240620";class Gn extends fn{constructor(){super(...arguments),Dn(this,"name","LLM:AnthropicAI"),Dn(this,"validImageMimeTypes",$n)}async chatRequest(e,t,s){if(s.messages=s?.messages||[],t&&s.messages.push({role:"user",content:t}),this.hasSystemMessage(s.messages)){const{systemMessage:e,otherMessages:t}=this.separateSystemMessages(s.messages);s.messages=t,s.system=e?.content}const n=s?.responseFormat||"json";"json"===n&&(s.system+=ws,s.messages.push({role:"assistant",content:Nn}));const o=s?.apiKey;if(!o)throw new Error("Please provide an API key for AnthropicAI");const r=new q({apiKey:o});try{const e={model:s.model,messages:s.messages,max_tokens:s.max_tokens,temperature:s.temperature,stop_sequences:s.stop_sequences,top_p:s.top_p,top_k:s.top_k},t=await r.messages.create(e);let o=t.content?.[0]?.text;const a=t?.stop_reason;return"json"===n&&(o=`${Nn}${o}`),{content:o,finishReason:a}}catch(e){throw qn.error("Error in componentLLMRequest in AnthropicAI: ",e),e instanceof q.APIError?e:new Error("Internal server error! Please try again later or contact support.")}}async visionRequest(e,t,s,n){s.messages=s?.messages||[];const o=s?.fileSources||[],r=n instanceof Qs?n.id:n,a=Ye.agent(r),i=await this.processValidFiles(o,a);if(0===i?.length)throw new Error(`Unsupported file(s). Please make sure your file is one of the following types: ${this.validImageMimeTypes.join(", ")}`);const l=[{type:"text",text:t},...i.map((e=>({type:"image",source:{type:"base64",data:e.base64data,media_type:e.mimetype}})))];s.messages.push({role:"user",content:l});const c=s?.responseFormat||"json";"json"===c&&(s.system=ws,s.messages.push({role:"assistant",content:Nn}));const u=s?.apiKey;if(!u)throw new Error("Please provide an API key for AnthropicAI");const m=new q({apiKey:u});try{const e={model:s.model,messages:s.messages,max_tokens:s.max_tokens,temperature:s.temperature,stop_sequences:s.stop_sequences,top_p:s.top_p,top_k:s.top_k},t=await m.messages.create(e);let n=t?.content?.[0]?.text;const o=t?.stop_reason;return"json"===c&&(n=`${Nn}${n}`),{content:n,finishReason:o}}catch(e){throw qn.error("Error in componentLLMRequest in Calude: ",e),e instanceof q.APIError?e:new Error("Internal server error! Please try again later or contact support.")}}async toolRequest(e,{model:t="claude-3-opus-20240229",messages:s,toolsConfig:{tools:n,tool_choice:o},apiKey:r=""}){try{if(!r)throw new Error("Please provide an API key for AnthropicAI");const e=new q({apiKey:r}),o={model:t,messages:[],max_tokens:4096};if(this.hasSystemMessage(s)){const{systemMessage:e,otherMessages:t}=this.separateSystemMessages(s);o.system=e?.content||"",o.messages=t}n&&n.length>0&&(o.tools=n);const a=await e.messages.create(o),i={role:a?.role||"user",content:a?.content||""},l=a?.stop_reason;let c=[],u=!1;if("tool_use"===l){const e=a?.content?.filter((e=>"tool_use"===e.type));if(0===e?.length)return;i.content=e,e.forEach(((e,t)=>{c.push({index:t,id:e?.id,type:"function",name:e?.name,arguments:e?.input,role:"user"})})),u=!0}const m=a?.content?.[0]?.text;return{data:{useTool:u,message:i,content:m,toolsData:c}}}catch(e){throw e}}async streamToolRequest(e,{model:t=jn,messages:s,toolsConfig:{tools:n,tool_choice:o},apiKey:r=""}){throw new Error("streamToolRequest() is Deprecated!")}async streamRequest(e,{model:t=jn,messages:s,toolsConfig:{tools:n,tool_choice:o},apiKey:r=""}){try{const e=new i;if(!r)throw new Error("Please provide an API key for AnthropicAI");const o=new q({apiKey:r}),a={model:t,messages:[],max_tokens:4096};if(this.hasSystemMessage(s)){const{systemMessage:e,otherMessages:t}=this.separateSystemMessages(s);a.system=e?.content||"",a.messages=this.checkMessagesConsistency(t)}else a.messages=this.checkMessagesConsistency(s);n&&n.length>0&&(a.tools=n);const l=o.messages.stream(a);l.on("error",(t=>{e.emit("error",t)}));let c=[];return l.on("text",(t=>{e.emit("content",t)})),l.on("finalMessage",(t=>{const s=t?.content?.filter((e=>"tool_use"===e.type));s?.length>0&&(s.forEach(((e,t)=>{c.push({index:t,id:e?.id,type:"function",name:e?.name,arguments:e?.input,role:"user"})})),e.emit("toolsData",c)),setTimeout((()=>{e.emit("end",c)}),100)})),e}catch(e){throw e}}checkMessagesConsistency(e){return e.length<=0||("user"===e[0].role&&Array.isArray(e[0].content)&&e[0].content.find((e=>"tool_result"===e.type))&&e.shift(),"user"!==e[0].role&&e.unshift({role:"user",content:"continue"})),e}async extractVisionLLMParams(e){return await super.extractVisionLLMParams(e)}formatToolsConfig({type:e="function",toolDefinitions:t,toolChoice:s="auto"}){let n=[];return"function"===e&&(n=t.map((e=>{const{name:t,description:s,properties:n,requiredFields:o}=e;return{name:t,description:s,input_schema:{type:"object",properties:n,required:o}}}))),n?.length>0?{tools:n}:{}}prepareInputMessageBlocks({messageBlock:e,toolsData:t}){const s=[];if(e){const t=[];if("object"==typeof e.content?t.push(e.content):t.push({type:"text",text:e.content}),e.tool_calls){const s=e.tool_calls.map((e=>({type:"tool_use",id:e.id,name:e?.function?.name,input:e?.function?.arguments})));t.push(...s)}s.push({role:e.role,content:t})}const n=t.map((e=>({role:"user",content:[{type:"tool_result",tool_use_id:e.id,content:e.result}]})));return[...s,...n]}async processValidFiles(e,t){const s=e.map((e=>async()=>e?"object"==typeof e&&e.url&&e.mimetype?await this.processObjectFileSource(e,t):z(e)?await this.processStringFileSource(e,t):null:null));return await K(s)}async processObjectFileSource(e,t){const{mimetype:s}=e;return this.validImageMimeTypes.includes(s)?{base64data:(await new lt(e).getBuffer()).toString("base64"),mimetype:s}:null}async processStringFileSource(e,t){let s="";return se(e)?s=await oe(e):(H(e)||Q(e))&&(s=(await Y(e)).mimetype),this.validImageMimeTypes.includes(s)?{base64data:(await new lt(e).getBuffer()).toString("base64"),mimetype:s}:null}}class Bn extends Re{register(){Te.register(U.LLM,"Echo",kn),Te.register(U.LLM,"OpenAI",vn),Te.register(U.LLM,"GoogleAI",En),Te.register(U.LLM,"AnthropicAI",Gn)}init(){Te.init(U.LLM,"Echo"),Te.init(U.LLM,"OpenAI"),Te.init(U.LLM,"GoogleAI"),Te.init(U.LLM,"AnthropicAI")}}class Vn extends on{user(e){return{get:async t=>await this.get(e.readRequest,t),set:async(t,s,n,o,r)=>await this.set(e.writeRequest,t,s,n,o,r),delete:async t=>{await this.delete(e.writeRequest,t)},exists:async t=>await this.exists(e.readRequest,t),getMetadata:async t=>await this.getMetadata(e.readRequest,t),setMetadata:async(t,s)=>{await this.setMetadata(e.writeRequest,t,s)},updateTTL:async(t,s)=>{await this.updateTTL(e.writeRequest,t,s)},getTTL:async t=>await this.getTTL(e.readRequest,t),getACL:async t=>await this.getACL(e.readRequest,t),setACL:async(t,s)=>{await this.setACL(e.writeRequest,t,s)}}}}var Un=Object.defineProperty,Fn=Object.getOwnPropertyDescriptor,Kn=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?Fn(t,s):t,a=e.length-1;a>=0;a--)(o=e[a])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&Un(t,s,r),r},Jn=(e,t,s)=>((e,t,s)=>t in e?Un(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const zn=ye("RedisCache");class Wn extends Vn{constructor(e){super(),Jn(this,"name","RedisCache"),Jn(this,"redis"),Jn(this,"_prefix","smyth:cache"),Jn(this,"_mdPrefix","smyth:metadata"),Jn(this,"accountConnector");const t=function(e){return"string"==typeof e?e.split(",").map((e=>{const[t,s]=e.split(":");return{host:t,port:Number(s)}})):Array.isArray(e)?e.map((e=>{if("string"==typeof e){const[t,s]=e.split(":");return{host:t,port:Number(s)}}return e})):[]}(e.hosts);this.redis=new $({sentinels:t,name:e.name,password:e.password}),this.redis.on("error",(e=>{zn.error("Redis Error:",e)})),this.redis.on("connect",(()=>{zn.log("Redis connected!")})),this.accountConnector=Te.getAccountConnector()}get client(){return this.redis}prefix(e){return`${this._prefix}:team_${e}`}mdPrefix(e){return`${this._mdPrefix}:team_${e}`}async get(e,t){const s=await this.accountConnector.getCandidateTeam(e.candidate);return await this.redis.get(`${this.prefix(s)}:${t}`)}async set(e,t,s,n,o,r){const a=e.candidate,i=[],l=await this.accountConnector.getCandidateTeam(e.candidate);i.push(this.redis.set(`${this.prefix(l)}:${t}`,s));const c=o||{};return c.acl=tt.from(n).addAccess(a.role,a.id,Ne.Owner).ACL,i.push(this.setMetadata(e,t,c)),r&&i.push(this.updateTTL(e,t,r)),await Promise.all(i),!0}async delete(e,t){const s=await this.accountConnector.getCandidateTeam(e.candidate);await Promise.all([this.redis.del(`${this.prefix(s)}:${t}`),this.redis.del(`${this.mdPrefix(s)}:${t}`)])}async exists(e,t){const s=await this.accountConnector.getCandidateTeam(e.candidate);return!!await this.redis.exists(`${this.prefix(s)}:${t}`)}async getMetadata(e,t){if(this.exists(e,t))try{const s=await this.accountConnector.getCandidateTeam(e.candidate),n=await this.redis.get(`${this.mdPrefix(s)}:${t}`);return n?this.deserializeRedisMetadata(n):{}}catch{return{}}}async setMetadata(e,t,s){const n=await this.accountConnector.getCandidateTeam(e.candidate);await this.redis.set(`${this.mdPrefix(n)}:${t}`,this.serializeRedisMetadata(s))}async updateTTL(e,t,s){if(s){const n=await this.accountConnector.getCandidateTeam(e.candidate);await Promise.all([this.redis.expire(`${this.prefix(n)}:${t}`,s),this.redis.expire(`${this.mdPrefix(n)}:${t}`,s)])}}async getTTL(e,t){const s=await this.accountConnector.getCandidateTeam(e.candidate);return this.redis.ttl(`${this.prefix(s)}:${t}`)}async getResourceACL(e,t){const s=await this.accountConnector.getCandidateTeam(t),n=await this.redis.get(`${this.mdPrefix(s)}:${e}`).catch((e=>{})),o=null!=n,r=o?this.deserializeRedisMetadata(n):{};return o?tt.from(r?.acl):(new tt).addAccess(t.role,t.id,Ne.Owner)}async getACL(e,t){try{return(await this.getMetadata(e,t))?.acl||{}}catch(e){throw zn.error("Error getting access rights in S3",e.name,e.message),e}}async setACL(e,t,s){try{let n=await this.getMetadata(e,t);n||(n={}),n.acl=tt.from(s).addAccess(e.candidate.role,e.candidate.id,Ne.Owner).ACL,await this.setMetadata(e,t,n)}catch(e){throw zn.error("Error setting access rights in S3",e),e}}serializeRedisMetadata(e){if(!e)return"";if(e.acl){const t=e.acl;t&&(e.acl=tt.from(t).serializedACL)}return JSON.stringify(e)}deserializeRedisMetadata(e){try{const t=JSON.parse(e);if(t.acl){const e=tt.from(t.acl).ACL;t.acl=e}return t}catch{return zn.warn("Error deserializing metadata",e),{}}}async stop(){super.stop(),await this.redis.quit()}}Kn([on.AccessControl],Wn.prototype,"get",1),Kn([on.AccessControl],Wn.prototype,"set",1),Kn([on.AccessControl],Wn.prototype,"delete",1),Kn([on.AccessControl],Wn.prototype,"exists",1),Kn([on.AccessControl],Wn.prototype,"getMetadata",1),Kn([on.AccessControl],Wn.prototype,"setMetadata",1),Kn([on.AccessControl],Wn.prototype,"updateTTL",1),Kn([on.AccessControl],Wn.prototype,"getTTL",1),Kn([on.AccessControl],Wn.prototype,"getACL",1),Kn([on.AccessControl],Wn.prototype,"setACL",1);class Hn extends Re{register(){Te.register(U.Cache,"Redis",Wn)}}class Qn extends on{}var Yn=Object.defineProperty,Xn=Object.getOwnPropertyDescriptor,Zn=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?Xn(t,s):t,a=e.length-1;a>=0;a--)(o=e[a])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&Yn(t,s,r),r},eo=(e,t,s)=>((e,t,s)=>t in e?Yn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);ye("JSONFileVault");class to extends Qn{constructor(e){if(super(),this.config=e,eo(this,"name","JSONFileVault"),eo(this,"vaultData"),eo(this,"index"),!sn.Instance)throw new Error("SRE not initialized");if(b.existsSync(e.file)){try{this.vaultData=JSON.parse(b.readFileSync(e.file).toString())}catch{this.vaultData={}}for(let e in this.vaultData)for(let t in this.vaultData[e]){this.index||(this.index={}),this.index[t]||(this.index[t]={});const s=this.vaultData[e][t];this.index[t][e]=s}}}user(e){return{get:async t=>this.get(e.readRequest,t),set:async(t,s)=>this.set(e.writeRequest,t,s),delete:async t=>this.delete(e.writeRequest,t),exists:async t=>this.exists(e.readRequest,t)}}async get(e,t){const s=await Te.getAccountConnector().getCandidateTeam(e.candidate);return this.vaultData?.[s]?.[t]}async set(e,t,s){throw new Error("JSONFileVault.set not allowed")}async delete(e,t){throw new Error("JSONFileVault.delete not allowed")}async exists(e,t){return!1}async getResourceACL(e,t){const s=await Te.getAccountConnector().getCandidateTeam(t),n=new tt;return this.vaultData?.[s]?.[e]&&n.addAccess(je.Team,s,Ne.Owner).addAccess(je.Team,s,Ne.Read).addAccess(je.Team,s,Ne.Write),n}}Zn([on.AccessControl],to.prototype,"get",1),Zn([on.AccessControl],to.prototype,"set",1),Zn([on.AccessControl],to.prototype,"delete",1),Zn([on.AccessControl],to.prototype,"exists",1);class so extends Re{register(){Te.register(U.Vault,"JSONFileVault",to)}}var no=Object.defineProperty,oo=(e,t,s)=>((e,t,s)=>t in e?no(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class ro extends _e{constructor(){super(...arguments),oo(this,"name","Account")}isTeamMember(e,t){return Promise.resolve(!0)}getCandidateTeam(e){return e.role===je.Team?Promise.resolve(e.id):Promise.resolve("default")}}class ao extends Re{register(){Te.register(U.Account,"Account",ro)}init(){Te.init(U.Account,"Account")}}var io=Object.defineProperty,lo=(e,t,s)=>((e,t,s)=>t in e?io(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const co=JSON.stringify({openapi:"3.0.1",info:{title:"{{model_name}}",description:"{{model_description}}",version:"{{version}}"},servers:[{url:"{{server_url}}"}],paths:{},components:{schemas:{}}}),uo=JSON.stringify({summary:"{{summary}}",operationId:"{{operationId}}","x-openai-isConsequential":!1,requestBody:{required:!0,content:{}},responses:{200:{description:"response",content:{"text/plain":{schema:{type:"string"}}}}}});class mo extends _e{constructor(){super(...arguments),lo(this,"name","AgentDataConnector")}async getOpenAPIJSON(e,t,s,n=!1){if(!e)throw new Error("Agent not found");const o=s&&"latest"!=s?`/v${s}/api`:"/api",r="object"==typeof e?e:await this.getAgentData(e,s),a=r.name;let i=n?r.data.behavior:r.data.shortDescription;i||(i=r.data.description);const l=r.data.version||"1.0.0",c=vt(co).parse({model_name:It(a),model_description:It(i),server_url:t,version:l}).clean().result,u=JSON.parse(c),m=r.data.components.filter((e=>"APIEndpoint"===e.name));for(let e of m){const t=e.data.ai_exposed||typeof e.data.ai_exposed>"u";if(n&&!t)continue;let s=(e.data.method||"post").toLowerCase(),r=n?e.data.description||e.data.doc:e.data.doc||e.data.description;const a=JSON.parse(vt(uo).parse({summary:r,operationId:e.data.endpoint}).clean().result);if(u.paths[o+"/"+e.data.endpoint]||(u.paths[o+"/"+e.data.endpoint]={}),u.paths[o+"/"+e.data.endpoint][s]=a,e.inputs.length>0)if("get"===s){delete a.requestBody,a.parameters=[];for(let t of e.inputs){const e={name:t.name,in:"query",description:t.description,required:!t.optional,schema:po(t.type)},{style:s,explode:n}=ho(t.type);s&&(e.style=s,e.explode=n),a.parameters.push(e)}}else{const t=[],s=!n&&e.inputs.some((e=>"binary"===e.type.toLowerCase().trim()))?"multipart/form-data":"application/json";a.requestBody.content[s]={};for(let o of e.inputs){o.optional||t.push(o.name),a.requestBody.content[s].schema||(a.requestBody.content[s].schema={type:"object"});const e=a.requestBody.content[s].schema||{type:"object"};e.properties||(e.properties={}),e.properties[o.name]={...po(o.type),format:n||"binary"!==o.type.toLowerCase().trim()?void 0:"binary",description:o.description,default:o.defaultVal},e.required=t,a.requestBody.content[s].schema||(a.requestBody.content["application/json"].schema=e)}}else delete a.requestBody}return u}}function po(e){switch(e?.toLowerCase()){case"binary":case"string":case"any":default:return{type:"string"};case"number":case"float":return{type:"number"};case"integer":return{type:"integer"};case"boolean":return{type:"boolean"};case"array":return{type:"array",items:{}};case"object":return{type:"object",additionalProperties:{}}}}function ho(e){switch(e.toLowerCase()){case"array":return{style:"form",explode:!1};case"object":return{style:"deepObject",explode:!0};default:return{style:"",explode:!1}}}var go=Object.defineProperty,fo=(e,t,s)=>((e,t,s)=>t in e?go(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class yo extends mo{constructor(e){super(),fo(this,"name","CLIAgentDataConnector"),fo(this,"argv"),this.argv=e.args||process.argv}async getAgentData(e,t){const s=Te.getCLIConnector().get("agent"),n=b.realpathSync(process.cwd()),o=w.join(n,s.agent);if(b.existsSync(o)){const e=b.readFileSync(o,"utf8");return{data:JSON.parse(e),version:t||"1.0"}}}getAgentIdByDomain(e){return Promise.resolve("")}async getAgentSettings(e,t){const s=Te.getCLIConnector().get("settings");let n;return"string"==typeof s.settings?b.existsSync(s.settings)&&(n=JSON.parse(b.readFileSync(s.settings,"utf8"))):n=s.settings,n}async isDeployed(e){return!0}}var bo=Object.defineProperty,wo=(e,t,s)=>((e,t,s)=>t in e?bo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class Ao extends mo{constructor(e){super(),wo(this,"name","LocalAgentDataConnector"),wo(this,"devDir"),wo(this,"prodDir"),wo(this,"agentsData",{dev:{},prod:{}}),wo(this,"agentSettings",{dev:{},prod:{}}),this.devDir=e.devDir,this.prodDir=e.prodDir}indexDir(e){const t=b.readdirSync(e),s={},n={};for(const o of t){const t=b.readFileSync(w.join(e,o),"utf8");let r;try{r=JSON.parse(t),r.id||(console.warn(`Agent data for ${o} does not contain an id, generating one...`),r.id="tmp-"+F())}catch(e){console.warn(`Error parsing agent data for ${o}: ${e.message}`)}r.components&&(s[r.id]=r),r.settings&&(n[r.id]=r.settings)}return{agentsData:s,agentSettings:n}}indexAgentsData(){const{agentsData:e,agentSettings:t}=this.indexDir(this.devDir),{agentsData:s,agentSettings:n}=this.indexDir(this.prodDir);this.agentsData={dev:e,prod:s},this.agentSettings={dev:t,prod:n}}async start(){super.start(),this.started=!1,this.indexAgentsData(),this.started=!0}async getAgentData(e,t){if(!await this.ready())throw new Error("Connector not ready");const s=t?this.agentsData.prod[e]:this.agentsData.dev[e];if(s)return{data:s,version:t||"1.0"};throw new Error(`Agent with id ${e} not found`)}getAgentIdByDomain(e){return Promise.resolve("")}async getAgentSettings(e,t){if(!await this.ready())throw new Error("Connector not ready");const s=t?this.agentSettings.prod[e]:this.agentSettings.dev[e];if(s)return s;throw new Error(`Settings for agent with id ${e} not found`)}async isDeployed(e){return!!this.agentsData.prod[e]}}class ko extends Re{register(){Te.register(U.AgentData,"AgentData",mo),Te.register(U.AgentData,"CLI",yo),Te.register(U.AgentData,"Local",Ao)}}class xo extends on{}var _o=Object.defineProperty,Io=Object.getOwnPropertyDescriptor,vo=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?Io(t,s):t,a=e.length-1;a>=0;a--)(o=e[a])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&_o(t,s,r),r},Co=(e,t,s)=>((e,t,s)=>t in e?_o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const Lo=ye("Pinecone VectorDB");class Po extends xo{constructor(e){if(super(),this.config=e,Co(this,"name","PineconeVectorDB"),Co(this,"_client"),Co(this,"indexName"),!sn.Instance)throw new Error("SRE not initialized");if(!e.pineconeApiKey)throw new Error("Pinecone API key is required");if(!e.indexName)throw new Error("Pinecone index name is required");this._client=new N({apiKey:e.pineconeApiKey}),Lo.info("Pinecone client initialized"),Lo.info("Pinecone index name:",e.indexName),this.indexName=e.indexName}get client(){return this._client}async getResourceACL(e,t){return(new tt).addAccess(t.role,t.id,Ne.Owner)}user(e){return{search:async(t,s,n)=>await this.search(e.readRequest,{indexName:this.indexName,namespace:t,query:s},n),insert:async(t,s)=>this.insert(e.writeRequest,{indexName:this.indexName,namespace:t,source:s}),delete:async(t,s)=>{await this.delete(e.writeRequest,{id:s,indexName:this.indexName,namespace:t})},createNamespace:async t=>{await this.createNamespace(e.writeRequest,t,this.indexName)},deleteNamespace:async t=>{await this.deleteNamespace(e.writeRequest,t,this.indexName)}}}async createNamespace(e,t,s){return new Promise((e=>e()))}async deleteNamespace(e,t,s){await this._client.Index(s).namespace(t).deleteAll()}async search(e,t,s={}){const n=this.client.Index(t.indexName).namespace(t.namespace);let o=t.query;return"string"==typeof t.query&&(o=await Qt.load().embedText(t.query)),(await n.query({topK:s?.topK||10,vector:o,includeMetadata:!0,includeValues:!0})).matches.map((e=>({id:e.id,values:e.values,metadata:e.metadata})))}async insert(e,t){let{source:s}=t;if(s=Array.isArray(s)?s:[s],s.some((e=>this.detectSourceType(e.source)!==this.detectSourceType(s[0].source))))throw new Error("All sources must be of the same type");const n=this.detectSourceType(s[0].source);if("unknown"===n||"url"===n)throw new Error("Invalid source type");const o=(await this.transformSource(s,n)).map((e=>({id:e.id,values:e.source,metadata:e.metadata})));return await this._client.Index(t.indexName).namespace(t.namespace).upsert(o),o.map((e=>e.id))}async delete(e,t){const s=Array.isArray(t.id)?t.id:[t.id];await this._client.Index(t.indexName).namespace(t.namespace).deleteMany(s)}detectSourceType(e){return"string"==typeof e?se(e)?"url":"text":Array.isArray(e)&&e.every((e=>"number"==typeof e))?"vector":"unknown"}transformSource(e,t){switch(t){case"text":{const t=e.map((e=>e.source));return Qt.load().embedTexts(t).then((s=>e.map(((e,n)=>({...e,source:s[n],metadata:{...e.metadata,text:t[n]}})))))}case"vector":return e}}}vo([on.AccessControl],Po.prototype,"createNamespace",1),vo([on.AccessControl],Po.prototype,"deleteNamespace",1),vo([on.AccessControl],Po.prototype,"search",1),vo([on.AccessControl],Po.prototype,"insert",1),vo([on.AccessControl],Po.prototype,"delete",1);class Oo extends Re{register(){Te.register(U.VectorDB,"Pinecone",Po)}}var To=Object.defineProperty,Ro=(e,t,s)=>((e,t,s)=>t in e?To(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class So extends _e{constructor(){super(),Ro(this,"name","CLI"),Ro(this,"params"),this.params=this.parse(process.argv)}parse(e,t){let s=t;s&&!Array.isArray(s)&&(s=[s]);const n=s||function(e){e||(e=process.argv);const t=e,s=[];for(let e=2;e<t.length;e++)t[e].startsWith("--")&&s.push(t[e].replace(/^--/,""));return s}(e);return ne(n,e)}get(e){let t=e;Array.isArray(t)||(t=[t]);const s={};return t.forEach((e=>{this.params[e]&&(s[e]=this.params[e])})),s}}class Eo extends Re{register(){Te.register(U.CLI,"CLI",So)}}class Mo extends on{user(e){return{get:async(t,s)=>this.get(e.readRequest,t,s),set:async(t,s,n)=>this.set(e.writeRequest,t,s,n),delete:async(t,s)=>this.delete(e.writeRequest,t,s),exists:async(t,s)=>this.exists(e.readRequest,t,s),deleteAll:async t=>this.deleteAll(e.writeRequest,t),list:async t=>this.list(e.readRequest,t)}}}var Do=Object.defineProperty,qo=Object.getOwnPropertyDescriptor,$o=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?qo(t,s):t,a=e.length-1;a>=0;a--)(o=e[a])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&Do(t,s,r),r},No=(e,t,s)=>((e,t,s)=>t in e?Do(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const jo=class extends Mo{constructor(){super(),No(this,"name","Redis"),No(this,"redisCacheConnector"),No(this,"accountConnector"),No(this,"schemaValidator"),this.redisCacheConnector=Te.getCacheConnector("Redis"),this.accountConnector=Te.getAccountConnector(),this.schemaValidator=c.object().keys({namespace:c.string().min(1).required(),key:c.string().min(1).required()})}async get(e,t,s){const n=await this.accountConnector.getCandidateTeam(e.candidate);return await this.redisCacheConnector.user(Ye.team(n)).get(`${t}:${s}`)}async set(e,t,s,n){const o=await this.accountConnector.getCandidateTeam(e.candidate);await this.redisCacheConnector.user(Ye.team(o)).set(`${t}:${s}`,n),!await this.redisCacheConnector.user(Ye.team(o)).exists(t)&&await this.redisCacheConnector.user(Ye.team(o)).set(t,"",void 0,{ns:!0})}async delete(e,t,s){const n=await this.accountConnector.getCandidateTeam(e.candidate);await this.redisCacheConnector.user(Ye.team(n)).delete(`${t}:${s}`)}async exists(e,t,s){const n=await this.accountConnector.getCandidateTeam(e.candidate);return await this.redisCacheConnector.user(Ye.team(n)).exists(`${t}:${s}`)}async list(e,t){const s=await this.accountConnector.getCandidateTeam(e.candidate);let n=await this.fetchKeysByPrefix(`${this.redisCacheConnector.prefix(s)}:${t}`);if(n=n.filter((e=>e!==`${this.redisCacheConnector.prefix(s)}:${t}`)),n.length<=0)return[];const o=this.redisCacheConnector.client.pipeline();n.forEach((e=>{o.get(e)}));const r=await o.exec();return n.map(((e,n)=>({key:e.replace(`${this.redisCacheConnector.prefix(s)}:${t}:`,""),data:r[n][1]})))}async deleteAll(e,t){const s=await this.accountConnector.getCandidateTeam(e.candidate);let n=await this.fetchKeysByPrefix(`${this.redisCacheConnector.prefix(s)}:${t}`);n=n.filter((e=>![`${this.redisCacheConnector.prefix(s)}:${t}`].includes(e))),await this.redisCacheConnector.client.del(n)}async getResourceACL(e,t){return this.redisCacheConnector.getResourceACL(e,t)}async fetchKeysByPrefix(e){let t="0";const s=[];do{const n=await this.redisCacheConnector.client.scan(t,"MATCH",`${e}*`,"COUNT",1e4);t=n[0],s.push(...n[1])}while("0"!==t);return s}static NamespaceAccessControl(e,t,s){const n=s.value;return s.value=async function(...e){let[t,s,o]=e;const r=void 0===o,a=await this.accountConnector.getCandidateTeam(t.candidate),i=r?s:`${s}:${o}`,l=`${this.redisCacheConnector.prefix(a)}:${i}`;if((await this.getAccessTicket(l,t)).access!==Fe.Granted)throw new Ke("Access Denied");return n.apply(this,e)},s}static Validate(e,t,s){const n=s.value;return s.value=async function(...e){let[t,s,o]=e;const r=this.schemaValidator.validate({namespace:s,key:o});if(r.error)throw new Error(`Validation Error: ${r.error.message}`);return n.apply(this,e)},s}};$o([jo.Validate,jo.NamespaceAccessControl],jo.prototype,"get",1),$o([jo.Validate,jo.NamespaceAccessControl],jo.prototype,"set",1),$o([jo.Validate,jo.NamespaceAccessControl],jo.prototype,"delete",1),$o([jo.Validate,jo.NamespaceAccessControl],jo.prototype,"exists",1),$o([jo.NamespaceAccessControl],jo.prototype,"list",1),$o([jo.NamespaceAccessControl],jo.prototype,"deleteAll",1);let Go=jo;class Bo extends Re{register(){Te.register(U.NKV,"Redis",Go)}}const Vo=ye("Boot");!function(){Vo.debug("SRE Boot sequence started");const e={};e.Account=new ao,e.Storage=new dn,e.VectorDB=new Oo,e.Cache=new Hn,e.LLM=new Bn,e.Vault=new so,e.AgentData=new ko,e.CLI=new Eo,e.NKV=new Bo,Ie.on("SRE:Initialized",(()=>{Vo.debug("SRE Initialized");for(let t in e)e[t].init();Ie.emit("SRE:Booted",e),Vo.debug("SRE Boot sequence completed")}))}();export{Qs as Agent,ms as AgentProcess,B as AgentRequest,$e as AgentSettings,yo as CLIAgentDataConnector,Te as ConnectorService,vs as Conversation,sn as SmythRuntime,ie as config};
//# sourceMappingURL=index.js.map
